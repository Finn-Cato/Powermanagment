<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Guard Settings</title>
  <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; background: #f5f5f7; color: #1d1d1f; }
    .container { max-width: 760px; margin: 0 auto; padding: 12px 8px 40px; }
    h1  { font-size: 22px; font-weight: 700; margin-bottom: 4px; color: #e8441a; }
    .header-top { position: relative; display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
    .header-title { flex: 1; }
    .subtitle { font-size: 13px; color: #636366; margin-bottom: 16px; }
    #guard-toggle { width: 30px; height: 18px; }
    #guard-toggle .slider { border-radius: 18px; }
    #guard-toggle .slider:before { height: 14px; width: 14px; }
    h2  { font-size: 15px; font-weight: 600; color: #1d1d1f; margin-bottom: 10px; }
    .card { background: #fff; border-radius: 12px; padding: 12px 10px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    .row { display: flex; align-items: flex-start; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; gap: 12px; }
    .row:last-child { border-bottom: none; padding-bottom: 0; }
    .row:first-child { padding-top: 0; }
    .label-group { flex: 1; }
    .label-group label { font-size: 13px; font-weight: 500; color: #1d1d1f; display: block; }
    .label-group .hint { font-size: 12px; color: #636366; margin-top: 2px; line-height: 1.4; }
    .control { flex-shrink: 0; display: flex; align-items: center; gap: 8px; }
    input[type=number] { width: 110px; padding: 6px 8px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 13px; }
    input[type=text], input[type=password] { padding: 6px 8px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 13px; }
    select { padding: 6px 8px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 13px; background: #fff; }
    input[type=checkbox] { width: 20px; height: 20px; cursor: pointer; accent-color: #e8441a; }
    input[type=range] { width: 110px; accent-color: #e8441a; }
    .range-val { min-width: 36px; text-align: right; font-size: 13px; color: #3a3a3c; font-weight: 500; }
    button { padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
    .btn-primary   { background: #e8441a; color: #fff; }
    .btn-secondary { background: #e5e5ea; color: #1d1d1f; }
    .btn-small     { padding: 5px 12px; font-size: 12px; }
    .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-box { background: #f5f5f7; border-radius: 10px; padding: 12px 14px; }
    .stat-box .stat-label { font-size: 11px; color: #636366; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 4px; }
    .stat-box .stat-value { font-size: 20px; font-weight: 700; color: #1d1d1f; }
    .stat-box .stat-sub   { font-size: 11px; color: #636366; margin-top: 2px; }
    .advanced-toggle { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; color: #636366; margin-top: 4px; user-select: none; }
    .advanced-toggle:hover { color: #1d1d1f; }
    #advanced-section { display: none; margin-top: 12px; border-top: 1px solid #f0f0f0; padding-top: 12px; }
    .log-entry { font-size: 12px; font-family: monospace; color: #3a3a3c; padding: 3px 0; }
    .log-time  { color: #aaa; margin-right: 6px; }
    .save-row  { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
    /* Tabs */
    .tab-bar { display: flex; border-bottom: 2px solid #e5e5ea; margin-bottom: 16px; }
    .tab-btn { background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; padding: 10px 22px; font-size: 14px; font-weight: 500; color: #636366; cursor: pointer; border-radius: 0; transition: all 0.2s ease; }
    .tab-btn.active { color: #1d1d1f !important; background: none !important; border: none !important; border-radius: 8px !important; font-weight: 600 !important; box-shadow: inset 0 0 0 1px #000000 !important; }
    .tab-btn:hover:not(.active) { color: #1d1d1f; background: rgba(0,0,0,0.04); border-radius: 8px 8px 0 0; }
    /* Device list */
    .dev-list { list-style: none; padding-left: 0; margin-left: 0; }
    .dev-list li { display: flex; align-items: center; gap: 2px; padding: 2px 4px 2px 2px; border-radius: 4px; margin-bottom: 0; }
    .dev-list li.managed   { background: #f5f5f7; border: 1.5px solid #fff; margin-bottom: 2px; border-radius: 8px; box-shadow: 0 0.5px 2px rgba(0,0,0,.06); }
    .dev-list li.unmanaged { background: #f5f5f7; opacity: 0.55; }
    .dev-list li.drag-over { background: #e5e5ea !important; }
    .handle { cursor: grab; color: #bbb; font-size: 13px; user-select: none; touch-action: none; min-width: 12px; width: 12px; text-align: center; flex-shrink: 0; }
    .reorder-btns { display: flex; flex-direction: column; gap: 0; flex-shrink: 0; }
    .reorder-btns button { background: transparent; border: none; padding: 0 1px; cursor: pointer; transition: transform 0.12s ease, filter 0.12s ease; line-height: 0; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    .reorder-btns button:hover:not(.pressing) { transform: scale(1.25); filter: brightness(1.2); }
    .reorder-btns button.pressing { transform: scale(0.85); }
    .reorder-btns button:disabled { opacity: 0.2; cursor: default; transform: none; filter: none; }
    @media (hover: none) { .reorder-btns button:hover:not(.pressing) { transform: scale(1); filter: none; } }
    .reorder-btns svg { display: block; }
    .priority-num { font-size: 10px; color: #636366; min-width: 14px; width: 14px; text-align: right; flex-shrink: 0; }
    .dev-name { flex: 1 1 0; font-size: 13px; font-weight: 600; color: #1d1d1f; overflow: hidden; text-overflow: ellipsis; min-width: 0; letter-spacing: 0.01em; white-space: normal; word-break: break-word; line-height: 1.25; }
    .dev-list select { font-size: 10px; padding: 2px 3px; max-width: 100px; flex-shrink: 0; }
    .dev-list input[type=number] { font-size: 11px; padding: 3px 4px; width: 50px; flex-shrink: 0; border: 1px solid #d1d1d6; border-radius: 4px; background: #fff; }
    .section-label { font-size: 11px; color: #636366; text-transform: uppercase; letter-spacing: .05em; font-weight: 600; padding: 5px 0 2px; }
    .room-label { font-size: 12px; color: #aaa; font-weight: 500; padding: 4px 2px 2px; display: flex; align-items: center; gap: 6px; }
    .room-label::after { content: ''; flex: 1; height: 1px; background: #ebebeb; }
    /* Toggle switch */
    .toggle { position: relative; display: inline-block; width: 38px; height: 22px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 22px; transition: background .2s; }
    .toggle .slider:before { position: absolute; content: ''; height: 18px; width: 18px; left: 2px; bottom: 2px; background: #fff; border-radius: 50%; transition: transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,.25); }
    .toggle input:checked + .slider { background: #34c759; }
    .toggle input:checked + .slider:before { transform: translateX(16px); }
    /* Misc */
    #toast { display: none; position: fixed; bottom: 24px; right: 24px; background: #34c759; color: #fff; padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 12px rgba(0,0,0,.15); }
    #error-banner { display: none; background: #ff3b30; color: #fff; padding: 10px 14px; border-radius: 10px; margin-bottom: 14px; font-size: 13px; word-break: break-word; }
    #connect-card { display: none; }
    #connect-card .steps { font-size: 12px; color: #636366; line-height: 1.8; margin-bottom: 14px; }
    #connect-card .steps b { color: #1d1d1f; }
    #token-row  { display: flex; gap: 8px; flex-wrap: wrap; }
    #token-input { flex: 1; min-width: 200px; font-family: monospace; font-size: 12px; }
    #connect-error { display: none; color: #ff3b30; font-size: 12px; margin-top: 8px; }
    #loading-indicator { text-align: center; padding: 30px; font-size: 13px; color: #636366; }
    /* Mobile responsive - use full width */
    @media (max-width: 600px) {
      .container { padding: 6px 4px 30px; max-width: 100%; }
      .card { border-radius: 8px; padding: 10px 6px; margin-bottom: 8px; }
      .row { padding: 7px 0; gap: 6px; }
      .label-group label { font-size: 14px; }
      .dev-name { font-size: 14px; }
      .dev-list li.managed { padding: 10px 0; }
      .dev-list li.managed .dev-name { font-size: 16px; font-weight: 700; }
      .dev-list li.managed .priority-num { font-size: 11px; }
      .dev-list li.managed select { font-size: 11px; }
      .dev-list select { max-width: 100px; font-size: 10px; }
      .tab-btn { padding: 5px 8px; font-size: 11px; }
      .status-grid { grid-template-columns: 1fr 1fr; gap: 6px; }
      .stat-box { padding: 8px 8px; }
      .header-top { flex-direction: column; align-items: flex-start; }
      .tab-bar { margin-bottom: 10px; }
      input[type=number] { width: 90px; }
    }
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body { background: #1d1d1f; color: #f5f5f7; }
      .card { background: #2a2a2c; box-shadow: 0 1px 4px rgba(0,0,0,.3); }
      h1 { color: #ff9500; }
      h2 { color: #f5f5f7; }
      .subtitle, .label-group .hint, .section-label { color: #a1a1a6; }
      .row { border-bottom-color: #424245; }
      .label-group label { color: #f5f5f7; }
      .dev-list li.managed { background: #2a2a2c; border-color: #424245; box-shadow: 0 0.5px 2px rgba(0,0,0,.3); }
      .dev-list li.unmanaged { background: #2a2a2c; }
      .dev-list li.drag-over { background: #3a3a3c !important; }
      .dev-name { color: #f5f5f7; }
      .priority-num { color: #a1a1a6; }
      input[type=number], input[type=text], input[type=password], select { background: #424245; color: #f5f5f7; border-color: #555555; }
      .range-val { color: #a1a1a6; }
      .stat-box { background: #2a2a2c; }
      .stat-box .stat-label { color: #a1a1a6; }
      .stat-box .stat-value { color: #f5f5f7; }
      .stat-box .stat-sub { color: #a1a1a6; }
      .btn-secondary { background: #424245; color: #f5f5f7; }
      .advanced-toggle { color: #a1a1a6; }
      .advanced-toggle:hover { color: #f5f5f7; }
      .log-entry { color: #a1a1a6; }
      .log-time { color: #888; }
      .tab-btn { color: #a1a1a6; }
      .tab-btn:hover:not(.active) { color: #f5f5f7; }
      .tab-btn.active { color: #f5f5f7 !important; background: none !important; border: none !important; border-radius: 8px !important; font-weight: 600 !important; box-shadow: inset 0 0 0 1px #ffffff !important; }
      .room-label { color: #a1a1a6; }
      .room-label::after { background: #424245; }
      #error-banner { background: #8b0000; color: #fff; }
    }
  </style>
</head>
<body>
<div class="container">

<div class="header-top">
  <div class="header-title">
    <h1>Power Guard</h1>
    <p class="subtitle">Automatically turns off devices before you exceed your power limit.</p>
  </div>
</div>

  <div id="error-banner"></div>
  <div id="loading-indicator">Connecting to Homeyâ€¦</div>

  <!-- Token fallback card -->
  <div class="card" id="connect-card">
    <h2>Connect to Homey API</h2>
    <div class="steps">
      Power Guard needs a Personal Access Token to read and save settings.<br>
      <b>1.</b> Go to <b>my.homey.app</b> â†’ your name â†’ <b>Account</b> â†’ <b>Security</b> â†’ <b>Personal Access Tokens</b><br>
      <b>2.</b> Create a new token with scope <b>homey:manager:api</b><br>
      <b>3.</b> Paste it below (held in memory only for this session).
    </div>
    <div id="token-row">
      <input type="password" id="token-input" placeholder="pat-apps-â€¦" autocomplete="off">
      <button class="btn-primary" onclick="connectWithToken()">Connect</button>
    </div>
    <div id="connect-error"></div>
  </div>

  <!-- Main content -->
  <div id="main-content" style="display:none">

    <!-- Tab bar -->
    <div class="tab-bar">
      <button class="tab-btn active" id="tb-settings" onclick="showTab('settings')">Settings</button>
      <button class="tab-btn"        id="tb-devices"  onclick="showTab('devices')">Devices</button>
      <button class="tab-btn"        id="tb-system"   onclick="showTab('system')">System</button>
      <button class="tab-btn"        id="tb-consumption" onclick="showTab('consumption')">Consumption</button>
    </div>

    <!-- â”€â”€ Settings tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-settings">

      <div class="card">
        <h2>Current Status</h2>
        <div class="status-grid">
          <div class="stat-box">
            <div class="stat-label">Power right now</div>
            <div class="stat-value" id="st-power">â€“ W</div>
            <div class="stat-sub">of <span id="st-limit">â€“</span> W limit</div>
          </div>
          <div class="stat-box">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;width:100%">
              <div>
                <div class="stat-label">Guard is active</div>
                <div class="stat-value" id="st-enabled-big">â€“</div>
                <div class="stat-sub" id="st-profile-sub">â€“</div>
              </div>
              <label class="toggle" id="guard-toggle" style="margin: 0;flex-shrink:0;margin-top:2px">
                <input type="checkbox" id="s-enabled-toggle" onchange="updateEnabledSync(this.checked)">
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Power meter</div>
            <div class="stat-value" id="st-han" style="font-size:14px;padding-top:4px">â€“</div>
            <div class="stat-sub" id="st-han-age" style="font-size:10px;color:#8e8e93"></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Devices controlled</div>
            <div class="stat-value" id="st-mitigation">â€“</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <div style="font-size:12px;color:#636366;margin-bottom:6px;font-weight:500">RECENT ACTIVITY</div>
          <div id="log-container"><div class="log-entry" style="color:#aaa">No activity yet.</div></div>
        </div>
        <div id="ev-section" style="display:none;margin-top:14px">
          <div style="font-size:12px;color:#636366;margin-bottom:6px;font-weight:500">EV CHARGERS</div>
          <div id="ev-grid" class="status-grid"></div>
        </div>
        <!-- Hidden sync element for s-enabled -->
        <input type="checkbox" id="s-enabled" style="display:none" onchange="syncEnabledCheckbox()" checked>
      </div>

      <div class="card">
        <div class="row">
          <div class="label-group">
            <label>Protection mode</label>
            <span class="hint"><b>Normal</b> â€” full limit. &nbsp;<b>Strict</b> â€” 90% of limit.</span>
          </div>
          <div class="control">
            <select id="s-profile">
              <option value="normal">Normal</option>
              <option value="strict">Strict</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Power Limit</h2>
        <div class="row">
          <div class="label-group">
            <label>Maximum power (W)</label>
            <span class="hint">Your grid connection limit. Typical: 10 000 W (10 kW) or 15 000 W (15 kW).</span>
          </div>
          <div class="control">
            <input type="number" id="s-powerLimitW" min="100" max="100000" step="500" value="10000">
            <span style="font-size:12px;color:#636366">W</span>
          </div>
        </div>
        <div class="row">
          <div class="label-group">
            <label>Time before acting (s)</label>
            <span class="hint">How long the limit must be exceeded before turning off a device.</span>
          </div>
          <div class="control">
            <input type="number" id="s-cooldownSeconds" min="5" max="300" step="5" value="30">
            <span style="font-size:12px;color:#636366">s</span>
          </div>
        </div>
        <div class="advanced-toggle" onclick="toggleAdvanced()">
          <span id="adv-arrow">&#9654;</span> Advanced settings
        </div>
        <div id="advanced-section">
          <div class="row" style="padding-top:12px">
            <div class="label-group"><label>Phase 1 limit (A)</label><span class="hint">0 = disabled</span></div>
            <div class="control"><input type="number" id="s-phase1LimitA" min="0" max="63" step="1" value="0"><span style="font-size:12px;color:#636366">A</span></div>
          </div>
          <div class="row">
            <div class="label-group"><label>Phase 2 limit (A)</label></div>
            <div class="control"><input type="number" id="s-phase2LimitA" min="0" max="63" step="1" value="0"><span style="font-size:12px;color:#636366">A</span></div>
          </div>
          <div class="row">
            <div class="label-group"><label>Phase 3 limit (A)</label></div>
            <div class="control"><input type="number" id="s-phase3LimitA" min="0" max="63" step="1" value="0"><span style="font-size:12px;color:#636366">A</span></div>
          </div>
          <div class="row">
            <div class="label-group"><label>Reaction speed</label><span class="hint">Readings to average. Lower = faster.</span></div>
            <div class="control">
              <input type="range" id="s-smoothingWindow" min="1" max="20" step="1" value="5">
              <span class="range-val" id="v-smoothingWindow">5</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Spike ignore threshold</label><span class="hint">Readings Ã— avg before ignoring as a spike.</span></div>
            <div class="control">
              <input type="range" id="s-spikeMultiplier" min="1.2" max="5.0" step="0.1" value="2.0">
              <span class="range-val" id="v-spikeMultiplier">2.0Ã—</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Confirm before acting</label><span class="hint">High readings in a row before switching off.</span></div>
            <div class="control">
              <input type="range" id="s-hysteresisCount" min="1" max="10" step="1" value="3">
              <span class="range-val" id="v-hysteresisCount">3</span>
            </div>
          </div>
        </div>
      </div>

      <div class="save-row">
        <button class="btn-secondary" onclick="loadAll()">Discard</button>
        <button class="btn-primary"   onclick="saveAll()">Save settings</button>
      </div>

    </div><!-- /#tab-settings -->

    <!-- â”€â”€ System tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-system" style="display:none">

      <div class="card">
        <h2>Electrical System Configuration</h2>
        <div class="row">
          <div class="label-group">
            <label>Main circuit voltage</label>
            <span class="hint">Select your electrical system type. This affects power calculations for EV charger control.</span>
          </div>
          <div class="control">
            <select id="s-voltageSystem">
              <option value="230v-1phase">230V Single-phase (Home)</option>
              <option value="400v-3phase">400V Three-phase (Industrial)</option>
            </select>
          </div>
        </div>
        <div class="row" id="phase-config-row" style="display:none">
          <div class="label-group">
            <label>Phase configuration</label>
            <span class="hint">For 3-phase systems, specify how chargers are distributed.</span>
          </div>
          <div class="control">
            <select id="s-phaseDistribution">
              <option value="balanced">Balanced (chargers on all 3 phases)</option>
              <option value="single-phase-a">Single Phase A only</option>
              <option value="single-phase-b">Single Phase B only</option>
              <option value="single-phase-c">Single Phase C only</option>
              <option value="two-phases">Two phases (custom)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Managed Chargers</h2>
        <div class="row" style="margin-bottom:12px;">
          <div class="label-group">
            <label>Main circuit breaker</label>
            <span class="hint">Max amperage for the charger circuit. Used to cap individual charger limits.</span>
          </div>
          <div class="control">
            <input type="number" id="s-mainCircuitA" min="10" max="100" step="1" value="25">
            <span style="font-size:12px;color:#636366">A</span>
          </div>
        </div>
        <div id="charger-details-list" style="font-size:12px;">
          <span style="color:#636366">â³ Loading chargers...</span>
        </div>

        <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e5ea;">
          <button class="btn-secondary" onclick="testChargerControl()" style="font-size:12px; padding:6px 14px;">
            ğŸ”Œ Test charger control
          </button>
          <button class="btn-secondary" onclick="showDiagnostics()" style="font-size:12px; padding:6px 14px; margin-left:6px;">
            ğŸ” Diagnostics
          </button>
          <div id="charger-test-result" style="margin-top:8px; font-size:12px; display:none;"></div>
        </div>
      </div>

      <div class="save-row">
        <button class="btn-secondary" onclick="loadAll()">Discard</button>
        <button class="btn-primary"   onclick="saveAll()">Save</button>
      </div>

    </div><!-- /#tab-system -->

    <!-- â”€â”€ Consumption tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-consumption" style="display:none">

      <div class="card">
        <h2>Power Consumption by Device</h2>
        <div style="font-size:12px;color:#636366;margin-bottom:12px;font-weight:500">
          Device type filters
        </div>
        <div id="device-type-filters" style="display:flex;flex-wrap:wrap;gap:14px;margin-bottom:14px;">
          <!-- Filters will be populated here -->
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <thead style="border-bottom:2px solid #e5e5ea;">
            <tr>
              <th style="text-align:left;padding:8px 0;color:#636366;font-weight:500;">Device</th>
              <th style="text-align:right;padding:8px 0;color:#636366;font-weight:500;">Current</th>
              <th style="text-align:right;padding:8px 0;color:#636366;font-weight:500;">Avg</th>
              <th style="text-align:right;padding:8px 0;color:#636366;font-weight:500;">Peak</th>
              <th style="text-align:right;padding:8px 0;color:#636366;font-weight:500;">Share</th>
            </tr>
          </thead>
          <tbody id="consumption-table">
            <tr>
              <td colspan="5" style="text-align:center;padding:24px;color:#aaa;">Loading...</td>
            </tr>
          </tbody>
        </table>
        <div style="font-size:11px;color:#999;margin-top:12px;text-align:right;">
          Last updated: <span id="consumption-time">â€“</span>
        </div>
      </div>

      <!-- Debug Log -->
      <div class="card" style="margin-top:20px;">
        <h2>Debug Log</h2>
        <div style="font-size:12px;color:#636366;margin-bottom:12px;font-weight:500">
          Live tracking log for power consumption
        </div>
        <button onclick="loadDebugLog()" style="padding:8px 16px;background:#007AFF;color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;margin-bottom:12px;">
          Refresh Log
        </button>
        <pre id="debug-log" style="background:#f5f5f5;padding:12px;border-radius:4px;font-size:11px;max-height:300px;overflow:auto;border:1px solid #e5e5ea;white-space:pre-wrap;word-wrap:break-word;color:#333;font-family:monospace;">Loading debug log...</pre>
      </div>

    </div><!-- /#tab-consumption -->

    <!-- â”€â”€ Devices tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-devices" style="display:none">

      <div class="card">
        <div id="cache-status" style="font-size:12px; color:#636366; margin-bottom:12px; padding: 8px; background:#f5f5f7; border-radius:8px;">
          <span id="cache-loading" style="color:#636366">â³ Loading devices...</span>
          <span id="cache-status-text" style="display:none; color:#34c759">âœ“</span>
          <span id="cache-refresh-btn" style="display:none; margin-left:12px;">
            <button class="btn-small btn-secondary" onclick="refreshDeviceCache()" style="padding:4px 10px; font-size:11px;">Refresh</button>
          </span>
        </div>

        <h2>Device priority</h2>
        <p style="font-size:13px;color:#636366;margin-bottom:4px;line-height:1.5">
          Toggle a device <b>on</b> to let Power Guard control it. Drag &#9776; to set the order â€”
          devices higher in the list are turned off first.
        </p>
        <div id="devices-list"></div>
      </div>

      <div class="save-row">
        <span id="dev-save-status" style="font-size:12px;color:#636366;margin-right:auto"></span>
        <button class="btn-secondary" onclick="loadAll()">Discard</button>
        <button class="btn-primary"   onclick="saveAll()">Save</button>
      </div>

    </div><!-- /#tab-devices -->

  </div><!-- /#main-content -->
</div>

<div id="toast">Settings saved!</div>

<!-- Debug log panel -->
<div id="debug-panel" style="position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;background:#1a1a2e;color:#0f0;font-family:monospace;font-size:11px;padding:8px 12px;z-index:9999;display:none;border-top:2px solid #e8441a;">
  <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
    <b style="color:#e8441a;">DEBUG LOG</b>
    <span>
      <button onclick="document.getElementById('debug-log').innerHTML=''" style="font-size:10px;padding:2px 8px;cursor:pointer;">Clear</button>
      <button onclick="document.getElementById('debug-panel').style.display='none'" style="font-size:10px;padding:2px 8px;cursor:pointer;">Hide</button>
    </span>
  </div>
  <div id="debug-log"></div>
</div>

<script>
  // â”€â”€ Debug logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function dbg(msg) {
    // Debug panel disabled â€” re-enable by changing display:none to display:block on #debug-panel
    return;
  }

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var _H              = null;
  var priorityList    = [];
  var availableDevices = [];
  var _lastChargerStatus = {};  // deviceId â†’ { status, statusLabel, currentA, powerW }
  var _mitigatedDeviceIds = {};  // deviceId â†’ true when Power Guard is controlling a device
  var _touchDragIdx   = null;
  var _touchTargetIdx = null;
  var _touchDragLi    = null;

  // â”€â”€ Homey.api() wrappers (return Promises) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Per official docs: Homey.api(method, path, body, callback)
  // Callback signature: function(err, result)

  function hApi(method, path, body) {
    return new Promise(function(resolve, reject) {
      _H.api(method, path, body, function(err, result) {
        if (err) {
          dbg('<span style="color:red">' + method + ' ' + path + ' error: ' + (err.message || err) + '</span>');
          reject(err);
        } else {
          dbg(method + ' ' + path + ' OK');
          resolve(result);
        }
      });
    });
  }

  // â”€â”€ Priority list persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function savePriorityList() {
    if (!_H) return;
    hApi('POST', '/priority-list', priorityList)
      .then(function() { dbg('Priority list saved'); })
      .catch(function(e) { dbg('Priority save error: ' + e.message); });
  }

  // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showError(msg)  { var e = document.getElementById('error-banner'); e.textContent = msg; e.style.display = 'block'; }
  function clearError()    { document.getElementById('error-banner').style.display = 'none'; }
  function showToast()     { var t = document.getElementById('toast'); t.style.display = 'block'; setTimeout(function() { t.style.display = 'none'; }, 2500); }
  function escHtml(s)      { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function toggleAdvanced() {
    var s = document.getElementById('advanced-section'), a = document.getElementById('adv-arrow');
    if (s.style.display === 'none' || !s.style.display) { s.style.display = 'block'; a.innerHTML = '&#9660;'; }
    else { s.style.display = 'none'; a.innerHTML = '&#9654;'; }
  }

  function showTab(name) {
    ['settings','system','devices','consumption'].forEach(function(t) {
      document.getElementById('tab-' + t).style.display  = t === name ? 'block' : 'none';
      document.getElementById('tb-'  + t).classList[t === name ? 'add' : 'remove']('active');
    });
    if (name === 'consumption') {
      loadConsumption();
    } else {
      loadAll();
    }
  }

  function showMain() {
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('connect-card').style.display     = 'none';
    document.getElementById('main-content').style.display     = 'block';
  }
  function showConnectCard() {
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('connect-card').style.display     = 'block';
  }

  // â”€â”€ Status UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var _lastPowerW = null;

  function updateStatusUI(s) {
    if (!s) return;
    var powerEl = document.getElementById('st-power');
    var newPower = Math.round(s.currentPowerW || 0);
    powerEl.textContent = newPower + ' W';
    // Flash power value green briefly when it changes
    if (_lastPowerW !== null && _lastPowerW !== newPower) {
      powerEl.style.transition = 'none';
      powerEl.style.color = '#34c759';
      setTimeout(function() {
        powerEl.style.transition = 'color 1s ease';
        powerEl.style.color = '';
      }, 50);
    }
    _lastPowerW = newPower;
    document.getElementById('st-limit').textContent       = Math.round(s.limitW || 0);
    document.getElementById('st-enabled-big').textContent = s.enabled ? 'ON' : 'OFF';
    document.getElementById('st-enabled-big').style.color = s.enabled ? '#34c759' : '#ff9500';
    document.getElementById('st-profile-sub').textContent =
      ({ normal: 'Normal mode', strict: 'Strict mode', solar: 'Solar-friendly' }[s.profile] || '');
    var h = document.getElementById('st-han');
    if (s.hanConnected) {
      h.textContent = 'Connected';
      h.style.color = '#34c759';
    } else {
      h.textContent = 'Not found';
      h.style.color = '#ff3b30';
    }
    // Show device brand and reading age
    var hanAge = document.getElementById('st-han-age');
    if (hanAge && s.hanLastSeen) {
      var ageSec = Math.round((Date.now() - s.hanLastSeen) / 1000);
      var ageText = ageSec < 5 ? 'Live' : ageSec < 60 ? ageSec + 's ago' : Math.round(ageSec / 60) + 'm ago';
      if (s.hanDeviceName) {
        hanAge.textContent = s.hanDeviceName + ' (' + ageText + ')';
      } else {
        hanAge.textContent = ageText;
      }
      hanAge.style.color = ageSec < 10 ? '#34c759' : ageSec < 30 ? '#ff9500' : '#ff3b30';
    } else if (hanAge) {
      hanAge.textContent = s.hanDeviceName || (s.hanConnected ? '' : 'No readings');
      hanAge.style.color = s.hanConnected ? '#636366' : '#ff3b30';
    }
    var n = (s.mitigatedDevices || []).length;
    var m = document.getElementById('st-mitigation');
    m.textContent = n || 'None';
    m.style.color = n > 0 ? '#ff9500' : '#34c759';
    // Track which devices are currently controlled for the Devices tab highlighting
    var prevIds = JSON.stringify(_mitigatedDeviceIds);
    _mitigatedDeviceIds = {};
    (s.mitigatedDevices || []).forEach(function(md) {
      _mitigatedDeviceIds[md.deviceId] = md.action || true;
    });
    // Re-render device list if the set of controlled devices changed
    if (JSON.stringify(_mitigatedDeviceIds) !== prevIds) {
      renderAllDevices();
    }
    var entries = (s.log || []).slice().reverse().slice(0, 8);
    document.getElementById('log-container').innerHTML = entries.length
      ? entries.map(function(e) {
          return '<div class="log-entry"><span class="log-time">' +
            (e.time ? new Date(e.time).toLocaleTimeString() : '') + '</span>' +
            escHtml(e.message || '') + '</div>';
        }).join('')
      : '<div class="log-entry" style="color:#aaa">No activity yet.</div>';
    var evChargers = Array.isArray(s.evChargers) ? s.evChargers : [];
    // Update cached charger status for the System tab table
    evChargers.forEach(function(c) {
      if (c.deviceId) {
        _lastChargerStatus[c.deviceId] = {
          status: c.status || 'charging',
          statusLabel: c.statusLabel || 'Charging',
          currentA: c.currentA || 0,
          powerW: c.powerW || 0
        };
        // Live-update the status badge in the System tab table without full re-render
        var badge = document.getElementById('charger-status-' + c.deviceId);
        if (badge) {
          var color = c.status === 'paused' ? '#ff3b30' :
                     c.status === 'dynamic' ? '#ff9500' :
                     c.status === 'charging' ? '#34c759' :
                     c.status === 'waiting' ? '#007aff' :
                     c.status === 'completed' ? '#34c759' :
                     c.status === 'connected' ? '#636366' : '#8e8e93';
          var icon = c.status === 'paused' ? '\u23f8' :
                    c.status === 'dynamic' ? '\u26a1' :
                    c.status === 'charging' ? '\ud83d\udd0b' :
                    c.status === 'waiting' ? '\u23f3' :
                    c.status === 'completed' ? '\u2705' :
                    c.status === 'connected' ? '\ud83d\udd0c' : '\u2796';
          badge.style.color = color;
          badge.textContent = icon + ' ' + (c.statusLabel || 'Idle');
        }
      }
    });
    var evSection = document.getElementById('ev-section');
    var evGrid = document.getElementById('ev-grid');
    if (evSection && evGrid) {
      if (evChargers.length) {
        evSection.style.display = 'block';
        evGrid.innerHTML = evChargers.map(function(c) {
          var statusColor = c.status === 'paused' ? '#ff3b30' :
                           c.status === 'dynamic' ? '#ff9500' :
                           c.status === 'charging' ? '#34c759' :
                           c.status === 'waiting' ? '#007aff' :
                           c.status === 'completed' ? '#34c759' :
                           c.status === 'connected' ? '#636366' : '#8e8e93';
          return '<div class="stat-box">' +
            '<div class="stat-label">' + escHtml(c.name || 'EV Charger') + '</div>' +
            '<div class="stat-value">' + Math.round(c.powerW || 0) + ' W</div>' +
            '<div class="stat-sub" style="color:' + statusColor + '">' + escHtml(c.statusLabel || 'Idle') + '</div>' +
            '</div>';
        }).join('');
      } else {
        evSection.style.display = 'none';
      }
    }
  }

  // â”€â”€ Apply settings to form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applySettings(s) {
    if (!s) return;
    document.getElementById('s-enabled').checked = s.enabled !== false;
    document.getElementById('s-enabled-toggle').checked = s.enabled !== false;
    document.getElementById('s-profile').value   = s.profile || 'normal';
    document.getElementById('s-voltageSystem').value = s.voltageSystem || '230v-1phase';
    document.getElementById('s-phaseDistribution').value = s.phaseDistribution || 'balanced';
    setNum('s-powerLimitW',     s.powerLimitW,    10000);
    setNum('s-cooldownSeconds', s.cooldownSeconds, 30);
    setNum('s-phase1LimitA',    s.phase1LimitA,   0);
    setNum('s-phase2LimitA',    s.phase2LimitA,   0);
    setNum('s-phase3LimitA',    s.phase3LimitA,   0);
    setNum('s-mainCircuitA',    s.mainCircuitA,   25);
    setRange('s-smoothingWindow', 'v-smoothingWindow', s.smoothingWindow, 5,   '');
    setRange('s-spikeMultiplier', 'v-spikeMultiplier', s.spikeMultiplier, 2.0, '\u00d7');
    setRange('s-hysteresisCount', 'v-hysteresisCount', s.hysteresisCount, 3,   '');
    if (s.classFilters && typeof s.classFilters === 'object') {
      _classFilters = s.classFilters;
    }
    priorityList = Array.isArray(s.priorityList) ? s.priorityList : [];
    updatePhaseConfigVisibility();
  }
  function setNum(id, val, fb) {
    var e = document.getElementById(id);
    if (e) e.value = (val != null) ? val : fb;
  }
  function setRange(id, vid, val, fb, sfx) {
    var e = document.getElementById(id), v = document.getElementById(vid), n = (val != null) ? val : fb;
    if (e) e.value = n;
    if (v) v.textContent = n + sfx;
  }

  // â”€â”€ System configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updatePhaseConfigVisibility() {
    var voltageSystem = document.getElementById('s-voltageSystem').value;
    var phaseRow = document.getElementById('phase-config-row');
    if (phaseRow) {
      phaseRow.style.display = (voltageSystem === '400v-3phase') ? 'flex' : 'none';
    }
    renderAllDevices();  // Refresh device list to update power calculations
    renderChargerDetails();  // Update charger power details based on voltage system
  }

  /**
   * Render charger-specific power details based on voltage system.
   */
  function renderChargerDetails() {
    var container = document.getElementById('charger-details-list');
    if (!container) return;

    // Use the already-loaded priorityList variable (no extra API call needed)
    var chargers = (priorityList || []).filter(function(e) { 
      return e.action === 'dynamic_current' && e.enabled !== false; 
    });

    if (chargers.length === 0) {
      container.innerHTML = '<span style="color:#636366">No dynamic chargers configured</span>';
      return;
    }

    var voltageSystem = document.getElementById('s-voltageSystem').value;
    var mainCircuitA = parseInt(document.getElementById('s-mainCircuitA').value) || 25;
    var voltageLabel = voltageSystem === '230v-1phase' ? '230V' : '400V';
    var voltageMultiplier = voltageSystem === '230v-1phase' ? 230 : 692;

    var html = '<table style="width:100%; border-collapse:collapse;">';
    html += '<thead><tr style="border-bottom:2px solid #e5e5ea;">' +
            '<th style="text-align:left; padding:8px 4px;">Charger</th>' +
            '<th style="text-align:center; padding:8px 4px;">Status</th>' +
            '<th style="text-align:center; padding:8px 4px;">Phases</th>' +
            '<th style="text-align:center; padding:8px 4px;">Circuit Limit</th>' +
            '<th style="text-align:center; padding:8px 4px;">Max Power</th>' +
            '</tr></thead><tbody>';

    var totalCircuitA = 0;
    var totalPowerW = 0;

    chargers.forEach(function(charger, idx) {
      var circuitA = charger.circuitLimitA || 32;
      var chargerPhases = charger.chargerPhases || 3;
      var effectiveA = Math.min(circuitA, mainCircuitA);
      // Per-charger voltage: 1-phase = 230V, 3-phase = 692V (âˆš3 Ã— 400)
      var perChargerVoltage = chargerPhases === 1 ? 230 : 692;
      var maxPowerW = Math.round(perChargerVoltage * effectiveA);

      totalCircuitA += circuitA;
      totalPowerW += maxPowerW;

      // Get live status from last status update
      var liveStatus = _lastChargerStatus[charger.deviceId] || { status: 'idle', statusLabel: 'Idle' };
      var statusColor = liveStatus.status === 'paused' ? '#ff3b30' :
                        liveStatus.status === 'dynamic' ? '#ff9500' :
                        liveStatus.status === 'charging' ? '#34c759' :
                        liveStatus.status === 'waiting' ? '#007aff' :
                        liveStatus.status === 'completed' ? '#34c759' :
                        liveStatus.status === 'connected' ? '#636366' :
                        '#8e8e93';
      var statusIcon = liveStatus.status === 'paused' ? 'â¸' :
                       liveStatus.status === 'dynamic' ? 'âš¡' :
                       liveStatus.status === 'charging' ? 'ğŸ”‹' :
                       liveStatus.status === 'waiting' ? 'â³' :
                       liveStatus.status === 'completed' ? 'âœ…' :
                       liveStatus.status === 'connected' ? 'ğŸ”Œ' :
                       'â–';

      var bgColor = idx % 2 === 0 ? 'transparent' : '#f5f5f7';
      html += '<tr style="background:' + bgColor + '; border-bottom:1px solid #e5e5ea;">' +
              '<td style="padding:8px 4px;">' + escHtml(charger.name) + '</td>' +
              '<td style="text-align:center; padding:8px 4px;">' +
              '<span id="charger-status-' + charger.deviceId + '" style="font-size:11px; font-weight:600; color:' + statusColor + '; white-space:nowrap;">' +
              statusIcon + ' ' + escHtml(liveStatus.statusLabel) + '</span></td>' +
              '<td style="text-align:center; padding:8px 4px;">' +
              '<select onchange="updateChargerPhases(\'' + charger.deviceId + '\',this.value)" ' +
              'style="font-size:12px; border:1px solid #e5e5ea; border-radius:4px; padding:2px 4px;">' +
              '<option value="1"' + (chargerPhases === 1 ? ' selected' : '') + '>1-phase</option>' +
              '<option value="3"' + (chargerPhases === 3 ? ' selected' : '') + '>3-phase</option>' +
              '</select>' +
              '</td>' +
              '<td style="text-align:center; padding:8px 4px;">' +
              '<input type="number" min="6" max="32" value="' + circuitA + '" ' +
              'onchange="updateChargerCircuitFromSystem(\'' + charger.deviceId + '\',this.value)" ' +
              'style="width:50px; font-size:12px; text-align:center; border:1px solid #e5e5ea; border-radius:4px; padding:2px 4px;">' +
              '<span style="font-size:11px; color:#636366;"> A</span>' +
              '</td>' +
              '<td style="text-align:center; padding:8px 4px;">' + (maxPowerW / 1000).toFixed(1) + ' kW</td>' +
              '</tr>';
    });

    // Total summary row
    html += '<tr style="border-top:2px solid #e5e5ea; font-weight:bold;">' +
            '<td style="padding:8px 4px;">Total (' + chargers.length + ' charger' + (chargers.length > 1 ? 's' : '') + ')</td>' +
            '<td></td>' +
            '<td></td>' +
            '<td style="text-align:center; padding:8px 4px;">' + totalCircuitA + ' A</td>' +
            '<td style="text-align:center; padding:8px 4px;">' + (totalPowerW / 1000).toFixed(1) + ' kW</td>' +
            '</tr>';

    html += '</tbody></table>';
    html += '<div style="font-size:11px; color:#636366; margin-top:8px; line-height:1.5;">' +
            'ğŸ’¡ Max Power per charger is capped by the main circuit breaker (' + mainCircuitA + 'A). ' +
            'Actual current will be reduced during overload mitigation.' +
            '</div>';

    container.innerHTML = html;
  }

  /**
   * Update a charger's circuit limit from the System tab, then refresh both views.
   */
  function updateChargerCircuitFromSystem(deviceId, val) {
    var ampVal = parseInt(val) || 32;
    if (ampVal < 6) ampVal = 6;
    if (ampVal > 32) ampVal = 32;
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) {
      entry.circuitLimitA = ampVal;
      savePriorityList();
      renderChargerDetails();
      renderAllDevices();
      hApi('POST', '/apply-circuit-limits', {})
        .then(function(data) { dbg('Circuit limits pushed: ' + JSON.stringify(data)); })
        .catch(function(err) { dbg('Circuit limit push error: ' + (err.message || err)); });
    }
  }

  function updateChargerPhases(deviceId, val) {
    var phases = parseInt(val) || 3;
    if (phases !== 1) phases = 3;
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) {
      entry.chargerPhases = phases;
      savePriorityList();
      renderChargerDetails();
      renderAllDevices();
    }
  }

  function testChargerControl() {
    var resultDiv = document.getElementById('charger-test-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<span style="color:#636366">â³ Testing charger control...</span>';

    hApi('POST', '/test-charger', {})
      .then(function(data) {
        if (!data || !data.steps) {
          resultDiv.innerHTML = '<span style="color:#ff3b30">âš  No response from test</span>';
          return;
        }
        var html = '';
        data.steps.forEach(function(step) {
          var icon = step.ok ? 'âœ…' : 'âŒ';
          html += '<div style="padding:3px 0; border-bottom:1px solid #e5e5ea;">' +
                  icon + ' <strong>' + step.step + '</strong>: ' +
                  '<span style="color:' + (step.ok ? '#34c759' : '#ff3b30') + ';">' + step.detail + '</span>' +
                  '</div>';
        });
        if (data.success) {
          html += '<div style="padding:6px 0; color:#34c759; font-weight:600;">âœ… Charger control is working!</div>';
        } else {
          html += '<div style="padding:6px 0; color:#ff3b30; font-weight:600;">âŒ Charger control failed â€” see details above</div>';
        }
        resultDiv.innerHTML = html;
      })
      .catch(function(err) {
        resultDiv.innerHTML = '<span style="color:#ff3b30">âš  Test failed: ' + (err.message || err) + '</span>';
      });
  }

  function showDiagnostics() {
    var resultDiv = document.getElementById('charger-test-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<span style="color:#636366">â³ Loading diagnostics...</span>';

    hApi('GET', '/diagnostic', null)
      .then(function(data) {
        if (!data) {
          resultDiv.innerHTML = '<span style="color:#ff3b30">âš  No data</span>';
          return;
        }
        var html = '<div style="padding:4px 0; font-weight:600; border-bottom:2px solid #e5e5ea;">Power Guard Diagnostics</div>';
        html += '<div style="padding:3px 0;">âš¡ <strong>Power:</strong> ' + (data.currentPowerW || 0) + 'W / ' + (data.limitW || 0) + 'W limit</div>';
        html += '<div style="padding:3px 0;">ğŸ“Š <strong>Over-limit count:</strong> ' + (data.overLimitCount || 0) + ' / ' + (data.hysteresisCount || 0) + ' needed</div>';
        html += '<div style="padding:3px 0;">ğŸ”Œ <strong>HAN connected:</strong> ' + (data.hanConnected ? 'âœ… Yes' : 'âŒ No') + '</div>';
        html += '<div style="padding:3px 0;">ğŸ“¡ <strong>Last HAN reading:</strong> ' + (data.lastHanReading || 'never') + '</div>';
        html += '<div style="padding:3px 0;">ğŸ“¦ <strong>Power buffer:</strong> ' + (data.powerBufferLen || 0) + ' readings</div>';
        html += '<div style="padding:3px 0;">ğŸ›¡ï¸ <strong>Guard enabled:</strong> ' + (data.enabled ? 'âœ… Yes' : 'âŒ No') + '</div>';
        html += '<div style="padding:3px 0;">â±ï¸ <strong>Cooldown:</strong> ' + (data.cooldownSeconds || 0) + 's</div>';
        html += '<div style="padding:3px 0;">ğŸ• <strong>Last mitigation:</strong> ' + (data.lastMitigationTime || 'never') + '</div>';

        var md = data.mitigatedDevices || [];
        html += '<div style="padding:3px 0;">ğŸ“‹ <strong>Devices controlled:</strong> ' + md.length + '</div>';
        md.forEach(function(m) {
          html += '<div style="padding:2px 0 2px 16px; color:#ff9500;">â†’ ' + m.deviceId.substring(0, 8) + '... action=' + m.action + (m.currentTargetA != null ? ' @ ' + m.currentTargetA + 'A' : '') + '</div>';
        });

        var chargers = data.easeeChargers || [];
        html += '<div style="padding:3px 0; margin-top:4px;"><strong>Configured chargers:</strong> ' + chargers.length + '</div>';
        chargers.forEach(function(c) {
          html += '<div style="padding:2px 0 2px 16px;">ğŸ”‹ ' + c.name + ' (limit=' + (c.circuitLimitA || '?') + 'A, enabled=' + c.enabled + ')</div>';
        });

        var logs = data.recentLog || [];
        if (logs.length) {
          html += '<div style="padding:3px 0; margin-top:4px;"><strong>Recent log:</strong></div>';
          logs.forEach(function(l) {
            html += '<div style="padding:1px 0 1px 16px; font-size:11px; color:#636366;">' + l + '</div>';
          });
        }

        resultDiv.innerHTML = html;
      })
      .catch(function(err) {
        resultDiv.innerHTML = '<span style="color:#ff3b30">âš  Diagnostics failed: ' + (err.message || err) + '</span>';
      });
  }

  function getVoltageConverter() {
    var voltageSystem = document.getElementById('s-voltageSystem').value;
    // Returns a function that converts amperage to watts
    if (voltageSystem === '400v-3phase') {
      // 400V 3-phase: P = âˆš3 Ã— 400V Ã— A = 692 Ã— A (per phase)
      return function(ampA) { return Math.round(692 * ampA); };
    } else {
      // 230V single-phase: P = 230V Ã— A
      return function(ampA) { return Math.round(230 * ampA); };
    }
  }

  function getMaxAmpFromWatt(wattW) {
    var voltageSystem = document.getElementById('s-voltageSystem').value;
    if (voltageSystem === '400v-3phase') {
      return Math.round(wattW / 692);
    } else {
      return Math.round(wattW / 230);
    }
  }

  // â”€â”€ Load all data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadAll() {
    clearError();
    dbg('Loading all data via Homey.api...');
    hApi('GET', '/all', null)
      .then(function(data) {
        var settings = data.settings || {};
        var status = data.status || {};
        var devices = data.devices || [];
        var defs = {
          enabled: true, profile: 'normal', powerLimitW: 10000,
          phase1LimitA: 0, phase2LimitA: 0, phase3LimitA: 0,
          smoothingWindow: 5, spikeMultiplier: 2.0,
          hysteresisCount: 3, cooldownSeconds: 30, priorityList: []
        };
        Object.keys(defs).forEach(function(k) {
          if (settings[k] == null) settings[k] = defs[k];
        });
        dbg('Settings loaded: ' + JSON.stringify(settings).substring(0, 200));
        applySettings(settings);
        updateStatusUI(status);
        availableDevices = Array.isArray(devices) ? devices : [];
        renderAllDevices();
        renderChargerDetails();  // Refresh charger details after loading
        dbg('Load complete: ' + availableDevices.length + ' devices');
      })
      .catch(function(err) {
        dbg('Load error: ' + (err.message || err));
        showError('Cannot load settings: ' + (err.message || err));
        renderAllDevices();
      });
  }

  // â”€â”€ Collect settings from form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function collectSettings() {
    var getNumValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      var val = parseInt(el.value, 10);
      return isNaN(val) ? fb : val;
    };
    var getFloatValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      var val = parseFloat(el.value);
      return isNaN(val) ? fb : val;
    };
    var getBoolValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      return el.checked !== undefined ? el.checked : fb;
    };
    var getStringValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      return el.value || fb;
    };
    return {
      enabled:         getBoolValue('s-enabled', true),
      profile:         getStringValue('s-profile', 'normal'),
      powerLimitW:     getNumValue('s-powerLimitW', 10000),
      phase1LimitA:    getNumValue('s-phase1LimitA', 0),
      phase2LimitA:    getNumValue('s-phase2LimitA', 0),
      phase3LimitA:    getNumValue('s-phase3LimitA', 0),
      smoothingWindow: getNumValue('s-smoothingWindow', 5),
      spikeMultiplier: getFloatValue('s-spikeMultiplier', 2.0),
      hysteresisCount: getNumValue('s-hysteresisCount', 3),
      cooldownSeconds: getNumValue('s-cooldownSeconds', 30),
      voltageSystem:   getStringValue('s-voltageSystem', '230v-1phase'),
      phaseDistribution: getStringValue('s-phaseDistribution', 'balanced'),
      mainCircuitA:    getNumValue('s-mainCircuitA', 25),
      classFilters:    _classFilters,
      priorityList:    priorityList
    };
  }

  // â”€â”€ Load Power Consumption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var _consumptionRefresh = null;
  var _classFilters = {}; // Track which device classes are visible
  
  function toggleClassFilter(className) {
    // Get the checkbox element first
    var checkbox = document.querySelector('[data-class-filter="' + className + '"]');
    if (!checkbox) return;
    
    // Use the checkbox's actual checked state (already changed by browser)
    _classFilters[className] = checkbox.checked;
    
    // Update visibility of all rows
    var rows = document.querySelectorAll('.consumption-row');
    rows.forEach(function(row) {
      var rowClass = row.getAttribute('data-device-class');
      var isVisible = _classFilters[rowClass] !== false;
      row.style.display = isVisible ? '' : 'none';
    });
    
    // Save immediately
    saveAll();
  }
  
  function loadConsumption() {
    if (!_H) { showError('Not connected to Homey'); return; }
    hApi('GET', '/powerConsumption', null)
      .then(function(data) {
        clearError();
        var devices = data.devices || [];
        var totalW = data.totalW || 0;
        var tbody = document.getElementById('consumption-table');
        if (!tbody)  return;

        if (devices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:24px;color:#aaa;">No devices with power data found</td></tr>';
          document.getElementById('consumption-time').textContent = 'â€“';
          document.getElementById('device-type-filters').innerHTML = '';
          return;
        }

        // Collect unique device classes
        var classesSet = {};
        devices.forEach(function(d) {
          var cls = d.class || 'unknown';
          classesSet[cls] = true;
        });
        var classes = Object.keys(classesSet).sort();

        // Create filter checkboxes
        var filterHtml = classes.map(function(cls) {
          var isChecked = _classFilters[cls] !== false;
          return '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;">' +
            '<input type="checkbox" data-class-filter="' + cls + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleClassFilter(\'' + cls + '\')" style="cursor:pointer;accent-color:#e8441a;">' +
            '<span style="font-size:13px;color:#1d1d1f;font-weight:500;">' + (cls.charAt(0).toUpperCase() + cls.slice(1)) + '</span>' +
            '</label>';
        }).join('');
        document.getElementById('device-type-filters').innerHTML = filterHtml;

        var rows = devices.map(function(d, idx) {
          var deviceName = (d.name || 'Unknown') + (d.class ? ' (' + d.class + ')' : '');
          var cls = d.class || 'unknown';
          var isVisible = _classFilters[cls] !== false;
          var display = isVisible ? '' : 'display:none;';
          return '<tr style="border-bottom:1px solid #f0f0f0;' + display + '" class="consumption-row" data-device-class="' + cls + '">' +
            '<td style="padding:10px 0;color:#1d1d1f;">' + (idx + 1) + '. ' + deviceName + '</td>' +
            '<td style="text-align:right;padding:10px 0;color:#1d1d1f;font-weight:500;">' + d.current + ' W</td>' +
            '<td style="text-align:right;padding:10px 0;color:#636366;">' + d.avg + ' W</td>' +
            '<td style="text-align:right;padding:10px 0;color:#636366;">' + d.peak + ' W</td>' +
            '<td style="text-align:right;padding:10px 0;color:#ff6b35;font-weight:500;">' + d.percent + '%</td>' +
            '</tr>';
        }).join('');
        tbody.innerHTML = rows;

        var timeStr = new Date(data.timestamp).toLocaleTimeString('sv-SE');
        document.getElementById('consumption-time').textContent = timeStr;
      })
      .catch(function(err) {
        showError('Failed to load power consumption: ' + err.message);
      });
  }

  // â”€â”€ Load Debug Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadDebugLog() {
    if (!_H) { showError('Not connected to Homey'); return; }
    hApi('GET', '/debugLog', null)
      .then(function(data) {
        clearError();
        var preElement = document.getElementById('debug-log');
        if (!preElement) return;
        
        if (data.ok && data.log) {
          // Show last 50 lines
          var lines = data.log.split('\n');
          var lastLines = lines.slice(-50).join('\n');
          preElement.textContent = lastLines || '[Empty log]';
          preElement.scrollTop = preElement.scrollHeight; // Scroll to bottom
        } else {
          preElement.textContent = data.log || '[Unable to read log]';
        }
      })
      .catch(function(err) {
        var preElement = document.getElementById('debug-log');
        if (preElement) {
          preElement.textContent = 'Error loading debug log: ' + err.message;
        }
      });
  }

  // Auto-load debug log when consumption tab is opened
  var _lastTabName = '';
  setInterval(function() {
    var consumptionTab = document.getElementById('tab-consumption');
    if (consumptionTab && consumptionTab.style.display === 'block') {
      if (_lastTabName !== 'consumption') {
        _lastTabName = 'consumption';
        loadDebugLog();
      }
    } else {
      _lastTabName = '';
    }
  }, 2000);

  setInterval(function() {
    var consumptionTab = document.getElementById('tab-consumption');
    if (consumptionTab && consumptionTab.style.display === 'block') {
      loadConsumption();
    }
  }, 2000); // Update every 2 seconds

  // â”€â”€ Save all settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveAll() {
    clearError();
    if (!_H) { showError('Not connected to Homey'); return; }
    var settings = collectSettings();
    dbg('Saving settings...');
    Promise.all([
      hApi('POST', '/settings', settings),
      hApi('POST', '/priority-list', priorityList)
    ])
      .then(function() {
        dbg('All settings saved successfully');
        showToast();
        // After saving, push circuit limits to the physical chargers
        return hApi('POST', '/apply-circuit-limits', {});
      })
      .then(function(data) {
        if (data && data.results) {
          var ok = data.results.filter(function(r) { return r.ok; }).length;
          dbg('Circuit limits pushed: ' + ok + '/' + data.results.length + ' chargers');
        }
      })
      .catch(function(err) {
        dbg('Save error: ' + (err.message || err));
        showError('Save failed: ' + (err.message || err));
      });
  }

  // â”€â”€ Devices tab rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function selOpt(cur, val) { return cur === val ? ' selected' : ''; }

  function renderAllDevices() {
    var container = document.getElementById('devices-list');
    if (!container) return;
    container.innerHTML = '';
    var managed = priorityList.slice().sort(function(a, b) { return (a.priority || 0) - (b.priority || 0); });
    var managedIds = {};
    managed.forEach(function(e) { managedIds[e.deviceId] = true; });
    var unmanaged = availableDevices.filter(function(d) { return !managedIds[d.id]; });

    if (managed.length) {
      var lbl1 = document.createElement('div');
      lbl1.className = 'section-label';
      lbl1.textContent = 'Managed \u2014 turned off first to last';
      container.appendChild(lbl1);
      var ul = document.createElement('ul');
      ul.className = 'dev-list';
      ul.id = 'priority-list';
      managed.forEach(function(entry, idx) {
        ul.appendChild(buildManagedRow(entry, idx, managed.length));
      });
      container.appendChild(ul);
    }

    if (unmanaged.length) {
      var lbl2 = document.createElement('div');
      lbl2.className = 'section-label';
      lbl2.textContent = managed.length ? 'Not managed' : 'Available devices \u2014 toggle on to manage';
      container.appendChild(lbl2);
      var groups = {};
      unmanaged.forEach(function(dev) {
        var zone = dev.zoneName || 'Other';
        if (!groups[zone]) groups[zone] = [];
        groups[zone].push(dev);
      });
      var zoneNames = Object.keys(groups).sort(function(a, b) { return a.localeCompare(b); });
      var multiRoom = zoneNames.length > 1;
      zoneNames.forEach(function(zone) {
        if (multiRoom) {
          var roomLbl = document.createElement('div');
          roomLbl.className = 'room-label';
          roomLbl.textContent = zone;
          container.appendChild(roomLbl);
        }
        var ul = document.createElement('ul');
        ul.className = 'dev-list';
        groups[zone].forEach(function(dev) { ul.appendChild(buildUnmanagedRow(dev)); });
        container.appendChild(ul);
      });
    }

    if (!managed.length && !unmanaged.length) {
      var msg = document.createElement('p');
      msg.style.cssText = 'color:#aaa;font-size:13px;padding:16px 0;text-align:center';
      msg.textContent = availableDevices.length
        ? 'Toggle devices on to manage them.'
        : 'No devices found. The cache is loading \u2014 this will update automatically.';
      container.appendChild(msg);
    }
  }

  function buildManagedRow(entry, idx, total) {
    var li = document.createElement('li');
    li.className = 'managed';
    var isControlled = !!_mitigatedDeviceIds[entry.deviceId];
    if (isControlled) {
      li.style.borderColor = '#ff9500';
      li.style.borderWidth = '2px';
      li.style.background = 'rgba(255, 149, 0, 0.08)';
    }
    li.innerHTML =
      '<span class="reorder-btns">' +
        '<button onclick="pressButton(this); moveDevice(' + idx + ',-1)"' + (idx === 0 ? ' disabled' : '') + ' title="Move up">' +
          '<svg width="13" height="13" viewBox="0 0 24 24"><defs><linearGradient id="gu' + idx + '" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="#1e40af"/><stop offset="40%" stop-color="#2563eb"/><stop offset="100%" stop-color="#60a5fa"/></linearGradient></defs><path d="M12 3L4 13h5v8h6v-8h5z" fill="url(#gu' + idx + ')" stroke="#1e3a8a" stroke-width="0.8" stroke-linejoin="round"/></svg>' +
        '</button>' +
        '<button onclick="pressButton(this); moveDevice(' + idx + ',1)"' + (idx === total - 1 ? ' disabled' : '') + ' title="Move down">' +
          '<svg width="13" height="13" viewBox="0 0 24 24"><defs><linearGradient id="gd' + idx + '" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#60a5fa"/><stop offset="60%" stop-color="#2563eb"/><stop offset="100%" stop-color="#1e40af"/></linearGradient></defs><path d="M12 21L4 11h5V3h6v8h5z" fill="url(#gd' + idx + ')" stroke="#1e3a8a" stroke-width="0.8" stroke-linejoin="round"/></svg>' +
        '</button>' +
      '</span>' +
      '<span class="priority-num">' + (idx + 1) + '.</span>' +
      '<span class="dev-name" style="' + (isControlled ? 'color:#ff9500;font-weight:700;' : '') + '">' + escHtml(entry.name) + (isControlled ? ' <span style="font-size:10px;font-weight:600;background:#ff9500;color:#fff;border-radius:3px;padding:1px 5px;margin-left:4px;">ACTIVE</span>' : '') + '</span>' +
      '<select onchange="updateDeviceAction(\'' + entry.deviceId + '\',this.value)">' +
        '<option value="onoff"'             + selOpt(entry.action,'onoff')             + '>Turn off</option>' +
        '<option value="dim"'               + selOpt(entry.action,'dim')               + '>Dim</option>' +
        '<option value="target_temperature"'+ selOpt(entry.action,'target_temperature')+ '>Lower thermostat</option>' +
        '<option value="charge_pause"'      + selOpt(entry.action,'charge_pause')      + '>Pause EV charging</option>' +
        '<option value="dynamic_current"'   + selOpt(entry.action,'dynamic_current')   + '>Dynamic charging (Easee)</option>' +
      '</select>' +
      '<label class="toggle" title="Managed \u2014 toggle to remove">' +
        '<input type="checkbox" checked onchange="toggleDevice(\'' + entry.deviceId + '\',this.checked)">' +
        '<span class="slider"></span>' +
      '</label>';
    return li;
  }

  function buildUnmanagedRow(dev) {
    var li = document.createElement('li');
    li.className = 'unmanaged';
    li.innerHTML =
      '<span class="handle" style="visibility:hidden">&#9776;</span>' +
      '<span class="priority-num" style="visibility:hidden">0.</span>' +
      '<span class="dev-name">' + escHtml(dev.name) + '</span>' +
      '<select id="def-action-' + dev.id.replace(/[^a-z0-9]/gi,'_') + '">' +
        '<option value="onoff">Turn off</option>' +
        '<option value="dim">Dim</option>' +
        '<option value="target_temperature">Lower thermostat</option>' +
        '<option value="charge_pause">Pause EV charging</option>' +
        '<option value="dynamic_current">Dynamic charging (Easee)</option>' +
      '</select>' +
      '<label class="toggle" title="Toggle on to manage this device">' +
        '<input type="checkbox" onchange="toggleDevice(\'' + dev.id + '\',this.checked)">' +
        '<span class="slider"></span>' +
      '</label>';
    return li;
  }

  // â”€â”€ Device list actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleDevice(deviceId, checked) {
    if (checked) {
      if (priorityList.some(function(e) { return e.deviceId === deviceId; })) return;
      var dev = availableDevices.filter(function(d) { return d.id === deviceId; })[0];
      if (!dev) return;
      var safeId = deviceId.replace(/[^a-z0-9]/gi, '_');
      var sel = document.getElementById('def-action-' + safeId);
      var action = sel ? sel.value : 'onoff';
      var maxPriority = Math.max(0, ...priorityList.map(function(e) { return e.priority || 0; }));
      priorityList.push({
        deviceId: deviceId, name: dev.name,
        priority: maxPriority + 1, action: action, enabled: true,
        minRuntimeSeconds: 0, minOffTimeSeconds: 60,
        circuitLimitA: 32
      });
    } else {
      var idx = -1;
      priorityList.forEach(function(e, i) { if (e.deviceId === deviceId) idx = i; });
      if (idx !== -1) {
        priorityList.splice(idx, 1);
        priorityList.forEach(function(e, i) { e.priority = i + 1; });
      }
    }
    renderAllDevices();
    savePriorityList();
  }

  function updateDeviceAction(deviceId, val) {
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) { entry.action = val; renderAllDevices(); savePriorityList(); }
  }

  function updateDeviceCircuitLimit(deviceId, val) {
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) { entry.circuitLimitA = parseInt(val) || 32; savePriorityList(); }
  }

  function reorderManaged(fromIdx, toIdx) {
    var sorted = priorityList.slice().sort(function(a, b) { return (a.priority || 0) - (b.priority || 0); });
    sorted.splice(toIdx, 0, sorted.splice(fromIdx, 1)[0]);
    sorted.forEach(function(x, i) { x.priority = i + 1; });
    renderAllDevices();
    savePriorityList();
  }

  function updateEnabledSync(checked) {
    document.getElementById('s-enabled').checked = checked;
    syncEnabledCheckbox();
  }

  function syncEnabledCheckbox() {
    var checked = document.getElementById('s-enabled').checked;
    document.getElementById('s-enabled-toggle').checked = checked;
    clearError();
    if (!_H) { showError('Not connected to Homey'); return; }
    var settings = collectSettings();
    hApi('/api/app/no.powerguard/settings', 'PUT', settings, function(err) {
      if (err) {
        showError(err.message || JSON.stringify(err));
        document.getElementById('s-enabled').checked = !checked;
        document.getElementById('s-enabled-toggle').checked = !checked;
      } else {
        showSuccess('Settings saved');
      }
    });
  }

  function pressButton(btn) {
    btn.classList.add('pressing');
    setTimeout(function() { btn.classList.remove('pressing'); }, 150);
  }

  function moveDevice(idx, direction) {
    var toIdx = idx + direction;
    if (toIdx < 0 || toIdx >= priorityList.length) return;
    reorderManaged(idx, toIdx);
  }

  // â”€â”€ Touch drag handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onTouchDragStart(e) {
    e.preventDefault();
    _touchDragLi = e.currentTarget.parentElement;
    var items = Array.from(document.querySelectorAll('#priority-list li'));
    _touchDragIdx   = items.indexOf(_touchDragLi);
    _touchTargetIdx = _touchDragIdx;
    _touchDragLi.style.opacity = '0.45';
  }
  function onTouchDragMove(e) {
    e.preventDefault();
    if (_touchDragIdx === null) return;
    var touch = e.touches[0];
    Array.from(document.querySelectorAll('#priority-list li')).forEach(function(item, i) {
      item.classList.remove('drag-over');
      var r = item.getBoundingClientRect();
      if (touch.clientY >= r.top && touch.clientY <= r.bottom) {
        _touchTargetIdx = i;
        if (i !== _touchDragIdx) item.classList.add('drag-over');
      }
    });
  }
  function onTouchDragEnd(e) {
    e.preventDefault();
    if (_touchDragLi) _touchDragLi.style.opacity = '';
    Array.from(document.querySelectorAll('#priority-list li')).forEach(function(item) {
      item.classList.remove('drag-over');
    });
    if (_touchDragIdx !== null && _touchTargetIdx !== null && _touchDragIdx !== _touchTargetIdx) {
      reorderManaged(_touchDragIdx, _touchTargetIdx);
    }
    _touchDragIdx = null; _touchTargetIdx = null; _touchDragLi = null;
  }

  // â”€â”€ Cache Status & Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showCacheStatus() {
    var loadingEl = document.getElementById('cache-loading');
    var statusEl = document.getElementById('cache-status-text');
    var refreshEl = document.getElementById('cache-refresh-btn');
    hApi('GET', '/cache-status', null)
      .then(function(data) {
        loadingEl.style.display = 'none';
        statusEl.style.display = 'inline';
        refreshEl.style.display = 'inline';
        if (data.cacheReady && data.cacheCount > 0) {
          statusEl.textContent = data.cacheCount + ' devices (updated ' + data.cacheAgeSeconds + 's ago)';
          statusEl.style.color = '#34c759';
          if (availableDevices.length === 0) {
            dbg('Cache ready, reloading device list...');
            loadAll();
          }
        } else if (data.cacheReady) {
          statusEl.textContent = 'Cache ready (0 devices)';
          statusEl.style.color = '#ff9500';
        } else {
          statusEl.textContent = 'Cache loading...';
          statusEl.style.color = '#636366';
        }
      })
      .catch(function() {
        if (availableDevices.length > 0) {
          loadingEl.style.display = 'none';
          statusEl.style.display = 'inline';
          refreshEl.style.display = 'inline';
          statusEl.textContent = availableDevices.length + ' devices loaded';
          statusEl.style.color = '#34c759';
        }
      });
  }

  function refreshDeviceCache() {
    var statusEl = document.getElementById('cache-status-text');
    statusEl.textContent = 'Refreshing...';
    statusEl.style.color = '#636366';
    hApi('POST', '/device-cache-refresh', null)
      .then(function(data) {
        if (data.success) {
          showCacheStatus();
          setTimeout(loadAll, 500);
        } else {
          statusEl.textContent = 'Refresh failed';
          statusEl.style.color = '#ff3b30';
        }
      })
      .catch(function(err) {
        statusEl.textContent = (err.message || 'Error');
        statusEl.style.color = '#ff3b30';
      });
  }

  function startCacheStatusPolling() {
    showCacheStatus();
    setInterval(showCacheStatus, 5000);
  }

  // â”€â”€ Range labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('s-smoothingWindow').addEventListener('input', function() {
    document.getElementById('v-smoothingWindow').textContent = this.value;
  });
  document.getElementById('s-spikeMultiplier').addEventListener('input', function() {
    document.getElementById('v-spikeMultiplier').textContent = parseFloat(this.value).toFixed(1) + '\u00d7';
  });
  document.getElementById('s-hysteresisCount').addEventListener('input', function() {
    document.getElementById('v-hysteresisCount').textContent = this.value;
  });

  // â”€â”€ Entry point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onHomeyReady(Homey) {
    _H = Homey;
    dbg('onHomeyReady called');

    // Probe what methods are available (for debug visibility)
    var methods = ['get','set','api','on','alert','confirm','ready','getLanguage','popup'];
    var avail = methods.filter(function(m) { return typeof Homey[m] === 'function'; });
    dbg('Homey methods: ' + avail.join(', '));

    Homey.ready();
    dbg('Homey.ready() called, api=' + (typeof Homey.api));

    // Setup event listeners
    var voltageSelect = document.getElementById('s-voltageSystem');
    if (voltageSelect) {
      voltageSelect.addEventListener('change', function() {
        updatePhaseConfigVisibility();
        savePriorityList();
      });
    }

    var mainCircuitInput = document.getElementById('s-mainCircuitA');
    if (mainCircuitInput) {
      mainCircuitInput.addEventListener('change', function() {
        renderChargerDetails();
        savePriorityList();
      });
    }

    // Load all data via Homey.api('GET', '/all', ...)
    hApi('GET', '/all', null)
      .then(function(data) {
        dbg('API connected! Keys: ' + Object.keys(data).join(', '));
        showMain();

        var settings = data.settings || {};
        var defs = {
          enabled: true, profile: 'normal', powerLimitW: 10000,
          phase1LimitA: 0, phase2LimitA: 0, phase3LimitA: 0,
          smoothingWindow: 5, spikeMultiplier: 2.0,
          hysteresisCount: 3, cooldownSeconds: 30, priorityList: []
        };
        Object.keys(defs).forEach(function(k) {
          if (settings[k] == null) settings[k] = defs[k];
        });

        applySettings(settings);
        updateStatusUI(data.status || {});
        availableDevices = Array.isArray(data.devices) ? data.devices : [];
        renderAllDevices();
        renderChargerDetails();  // Initial render of charger power details
        dbg('Initial load: ' + availableDevices.length + ' devices');

        // Immediately update cache status bar since devices are loaded
        if (availableDevices.length > 0) {
          var _l = document.getElementById('cache-loading');
          var _s = document.getElementById('cache-status-text');
          var _r = document.getElementById('cache-refresh-btn');
          if (_l) _l.style.display = 'none';
          if (_s) { _s.style.display = 'inline'; _s.textContent = availableDevices.length + ' devices loaded'; _s.style.color = '#34c759'; }
          if (_r) _r.style.display = 'inline';
        }

        startCacheStatusPolling();

        // Poll live status every 2 seconds for responsive updates
        setInterval(function() {
          hApi('GET', '/status', null)
            .then(function(s) { if (s) updateStatusUI(s); })
            .catch(function(err) { dbg('Status poll error: ' + (err.message || err)); });
        }, 2000);

        // Full data refresh every 30 seconds to keep everything in sync
        setInterval(function() {
          loadAll();
        }, 30000);
      })
      .catch(function(err) {
        dbg('Initial load error: ' + (err.message || err));
        showError('Cannot connect: ' + (err.message || err));
        showMain();
      });

    // Realtime events (per SDK docs: Homey.on(event, callback))
    try {
      Homey.on('status', function(s) { if (s) updateStatusUI(s); });
      dbg('Registered realtime: status');
    } catch (e) { dbg('Realtime status failed: ' + e.message); }

    try {
      Homey.on('priorityList', function(list) {
        if (!Array.isArray(list)) return;
        priorityList = list;
        renderAllDevices();
        renderChargerDetails();  // Update charger details when priority list changes
      });
      dbg('Registered realtime: priorityList');
    } catch (e) { dbg('Realtime priorityList failed: ' + e.message); }

    // Refresh data every time the page becomes visible (e.g. switching back to the app)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) loadAll();
    });

    // Periodic sync fallback every 15s
    setInterval(function() {
      hApi('GET', '/settings-all', null)
        .then(function(s) {
          if (!s || !s.priorityList) return;
          var incoming = JSON.stringify(s.priorityList.slice().sort(function(a, b) { return a.deviceId < b.deviceId ? -1 : 1; }));
          var current = JSON.stringify(priorityList.slice().sort(function(a, b) { return a.deviceId < b.deviceId ? -1 : 1; }));
          if (incoming !== current) {
            priorityList = s.priorityList;
            renderAllDevices();
            renderChargerDetails();  // Update charger details if priority list changed
          }
        })
        .catch(function() {});
    }, 15000);
  }
</script>
</body>
</html>
