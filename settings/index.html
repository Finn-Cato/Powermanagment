<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Power Guard Settings</title>
  <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --brand: #e8441a;
      --brand-soft: rgba(232,68,26,.08);
      --orange: #f97316;
      --green: #22c55e;
      --blue: #3b82f6;
      --text-primary: #1d1d1f;
      --text-muted: #636366;
      --text-secondary: #3a3a3c;
      --text-tertiary: #aaa;
      --bg-body: #eef2f8;
      --bg-card: #fff;
      --bg-surface: #f5f5f7;
      --bg-tab-bar: #fff;
      --bg-input: #fff;
      --border-color: #e5e5ea;
      --border-light: #f0f0f5;
      --input-border: #d1d1d6;
      --divider-color: #ebebeb;
      --shadow-sm: 0 1px 4px rgba(0,0,0,.07);
      --shadow-md: 0 4px 16px rgba(0,0,0,.1);
      --shadow: rgba(0,0,0,.08);
      --toggle-off: #ccc;
      --radius: 16px;
      --radius-sm: 10px;
      --radius-xs: 6px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; background: var(--bg-body); color: var(--text-primary); }
    .container { max-width: 760px; margin: 0 auto; padding: 12px 8px 40px; }
    h1  { font-size: 22px; font-weight: 700; margin-bottom: 4px; color: #fff; }
    .header-top { position: relative; display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: var(--radius); padding: 18px 20px 14px; overflow: hidden; }
    .header-top::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at 80% 50%, rgba(232,68,26,.22) 0%, transparent 60%); pointer-events:none; }
    .header-title { flex: 1; position: relative; z-index: 1; }
    .header-top h1 span { color: var(--brand); }
    .subtitle { font-size: 13px; color: rgba(255,255,255,.55); margin-bottom: 0; }
    #guard-toggle { width: 30px; height: 18px; }
    #guard-toggle .slider { border-radius: 18px; }
    #guard-toggle .slider:before { height: 14px; width: 14px; }
    h2  { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    h2::before { content:''; width:3px; height:16px; border-radius:2px; background:var(--brand); flex-shrink:0; }
    .card { background: var(--bg-card); border-radius: var(--radius); padding: 16px 14px; margin-bottom: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); }
    .row { display: flex; align-items: flex-start; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-light); gap: 12px; }
    .row:last-child { border-bottom: none; padding-bottom: 0; }
    .row:first-child { padding-top: 0; }
    .label-group { flex: 1; }
    .label-group label { font-size: 13px; font-weight: 500; color: var(--text-primary); display: block; }
    .label-group .hint { font-size: 12px; color: var(--text-muted); margin-top: 2px; line-height: 1.4; }
    .control { flex-shrink: 0; display: flex; align-items: center; gap: 8px; }
    input[type=number] { width: 110px; padding: 6px 8px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary); }
    input[type=text], input[type=password] { padding: 6px 8px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary); }
    select { padding: 6px 8px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary); }
    input[type=checkbox] { width: 20px; height: 20px; cursor: pointer; accent-color: #e8441a; }
    input[type=range] { width: 110px; accent-color: #e8441a; }
    .range-val { min-width: 36px; text-align: right; font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    button { padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
    .btn-primary   { background: #e8441a; color: #fff; }
    .btn-secondary { background: var(--border-color); color: var(--text-primary); }
    .btn-small     { padding: 5px 12px; font-size: 12px; }
    .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-box { background: var(--bg-surface); border-radius: var(--radius-sm); padding: 12px 14px; border-left: 3px solid var(--brand); }
    .stat-box .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .04em; margin-bottom: 4px; }
    .stat-box .stat-value { font-size: 22px; font-weight: 800; color: var(--text-primary); }
    .stat-box .stat-sub   { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .advanced-toggle { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; color: var(--text-muted); margin-top: 4px; user-select: none; }
    .advanced-toggle:hover { color: var(--text-primary); }
    #advanced-section { display: none; margin-top: 12px; border-top: 1px solid var(--border-light); padding-top: 12px; }
    .log-entry { font-size: 12px; font-family: monospace; color: var(--text-secondary); padding: 3px 0; }
    .log-time  { color: var(--text-tertiary); margin-right: 6px; }
    .save-row  { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
    /* Tabs */
    .tab-bar { display: flex; flex-wrap: nowrap; gap: 0; margin-bottom: 16px; padding: 0 4px; background: var(--bg-tab-bar); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); }
    .tab-btn { background: none; border: none; border-bottom: 2.5px solid transparent; padding: 10px 4px 7px; font-size: 12px; font-weight: 500; color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 2px; white-space: nowrap; flex: 1 1 0; justify-content: center; min-width: 0; -webkit-tap-highlight-color: transparent; }
    .tab-btn .tab-icon { font-size: 18px; line-height: 1; }
    .tab-btn .tab-label { font-size: 10px; overflow: hidden; text-overflow: ellipsis; }
    .tab-btn.active { color: var(--brand); background: var(--brand-soft); border-bottom-color: var(--brand); font-weight: 700; border-radius: var(--radius-sm) var(--radius-sm) 0 0; }
    .tab-btn:hover:not(.active) { color: var(--text-primary); background: rgba(0,0,0,.03); }
    /* Device list */
    .dev-list { list-style: none; padding-left: 0; margin-left: 0; }
    .dev-list li { display: flex; align-items: center; gap: 2px; padding: 2px 4px 2px 2px; border-radius: 4px; margin-bottom: 0; }
    .dev-list li.managed   { background: var(--bg-surface); border: 1.5px solid var(--bg-card); margin-bottom: 2px; border-radius: 8px; box-shadow: 0 0.5px 2px var(--shadow); }
    .dev-list li.unmanaged { background: var(--bg-surface); opacity: 0.55; }
    .dev-list li.drag-over { background: var(--border-color) !important; }
    .handle { cursor: grab; color: var(--text-tertiary); font-size: 13px; user-select: none; touch-action: none; min-width: 12px; width: 12px; text-align: center; flex-shrink: 0; }
    .reorder-btns { display: flex; flex-direction: column; gap: 0; flex-shrink: 0; }
    .reorder-btns button { background: transparent; border: none; padding: 0 1px; cursor: pointer; transition: transform 0.12s ease, filter 0.12s ease; line-height: 0; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    .reorder-btns button:hover:not(.pressing) { transform: scale(1.25); filter: brightness(1.2); }
    .reorder-btns button.pressing { transform: scale(0.85); }
    .reorder-btns button:disabled { opacity: 0.2; cursor: default; transform: none; filter: none; }
    @media (hover: none) { .reorder-btns button:hover:not(.pressing) { transform: scale(1); filter: none; } }
    .reorder-btns svg { display: block; }
    .priority-num { font-size: 10px; color: var(--text-muted); min-width: 14px; width: 14px; text-align: right; flex-shrink: 0; }
    .dev-name { flex: 1 1 0; font-size: 13px; font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; min-width: 0; letter-spacing: 0.01em; white-space: normal; word-break: break-word; line-height: 1.25; }
    .dev-list select { font-size: 10px; padding: 2px 3px; max-width: 100px; flex-shrink: 0; }
    .dev-list input[type=number] { font-size: 11px; padding: 3px 4px; width: 50px; flex-shrink: 0; border: 1px solid var(--input-border); border-radius: 4px; background: var(--bg-card); }
    .section-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; font-weight: 600; padding: 5px 0 2px; }
    .room-label { font-size: 12px; color: var(--text-tertiary); font-weight: 500; padding: 4px 2px 2px; display: flex; align-items: center; gap: 6px; }
    .room-label::after { content: ''; flex: 1; height: 1px; background: var(--divider-color); }
    /* Toggle switch */
    .toggle { position: relative; display: inline-block; width: 38px; height: 22px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--toggle-off, #ccc); border-radius: 22px; transition: background .2s; }
    .toggle .slider:before { position: absolute; content: ''; height: 18px; width: 18px; left: 2px; bottom: 2px; background: #fff; border-radius: 50%; transition: transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,.25); }
    .toggle input:checked + .slider { background: #34c759; }
    .toggle input:checked + .slider:before { transform: translateX(16px); }
    /* Misc */
    #toast { display: none; position: fixed; bottom: 24px; right: 24px; background: #34c759; color: #fff; padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 12px rgba(0,0,0,.15); }
    #error-banner { display: none; background: #ff3b30; color: #fff; padding: 10px 14px; border-radius: 10px; margin-bottom: 14px; font-size: 13px; word-break: break-word; }
    #connect-card { display: none; }
    #connect-card .steps { font-size: 12px; color: var(--text-muted); line-height: 1.8; margin-bottom: 14px; }
    #connect-card .steps b { color: var(--text-primary); }
    #token-row  { display: flex; gap: 8px; flex-wrap: wrap; }
    #token-input { flex: 1; min-width: 200px; font-family: monospace; font-size: 12px; }
    #connect-error { display: none; color: #ff3b30; font-size: 12px; margin-top: 8px; }
    #loading-indicator { text-align: center; padding: 30px; font-size: 13px; color: var(--text-muted); }
    /* Mobile responsive - use full width */
    @media (max-width: 600px) {
      .container { padding: 6px 4px 30px; max-width: 100%; }
      .card { border-radius: 8px; padding: 10px 6px; margin-bottom: 8px; }
      .row { padding: 7px 0; gap: 6px; }
      .label-group label { font-size: 14px; }
      .dev-name { font-size: 14px; }
      .dev-list li.managed { padding: 10px 0; }
      .dev-list li.managed .dev-name { font-size: 16px; font-weight: 700; }
      .dev-list li.managed .priority-num { font-size: 11px; }
      .dev-list li.managed select { font-size: 11px; }
      .dev-list select { max-width: 100px; font-size: 10px; }
      .tab-btn { padding: 6px 2px; }
      .tab-btn .tab-icon { font-size: 16px; }
      .tab-btn .tab-label { font-size: 9px; }
      .tab-bar { padding: 2px; margin-bottom: 10px; border-radius: 8px; }
      .status-grid { grid-template-columns: 1fr 1fr; gap: 6px; }
      .stat-box { padding: 8px 8px; }
      .header-top { flex-direction: column; align-items: flex-start; }
      input[type=number] { width: 90px; }
    }
    /* ── Heater Row Styles ──────────────────────────────────────────────── */
    .heater-list { display: flex; flex-direction: column; padding-left: 14px; }
    .heater-row { display:flex; align-items:center; gap:10px; padding:10px 0 10px 11px; border-bottom:1px solid var(--border-light); border-left:3px solid transparent; margin-left:-14px; transition:border-color .2s, background .2s; }
    .heater-row:last-child { border-bottom: none; }
    .heater-row.is-on { border-left-color:var(--orange); background:rgba(249,115,22,.04); border-radius:0 var(--radius-xs) var(--radius-xs) 0; }
    .h-dot { width:7px; height:7px; border-radius:50%; background:var(--border-color); flex-shrink:0; transition:background .3s; }
    .heater-row.is-on .h-dot { background:var(--orange); box-shadow:0 0 5px rgba(249,115,22,.5); }
    .h-info { flex: 1; min-width: 0; }
    .h-name { font-size: 13px; font-weight: 600; color: var(--text-primary); line-height: 1.3; word-break: break-word; display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
    .h-cur { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .h-cur b { color: var(--text-primary); font-weight: 600; }
    .h-controls { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .h-stepper { display: inline-flex; align-items: center; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; height: 26px; background: var(--bg-card); }
    .h-step-btn { width: 26px; height: 26px; border: none; background: transparent; color: var(--text-primary); font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
    .h-step-btn:active { background: var(--border-color); }
    .h-temp-val { min-width: 32px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--text-primary); border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); padding: 0 2px; }
    .h-temp-val.is-dirty { color: var(--blue); }
    .h-set-btn { height: 16px; padding: 0 6px; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 700; color: #fff; background: var(--blue); flex-shrink: 0; display: inline-flex; align-items: center; align-self: center; letter-spacing: 0.3px; }
    .h-set-btn:active { opacity: .7; }
    /* Slide toggle */
    .h-toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; cursor: pointer; }
    .h-toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .h-toggle .h-track { position: absolute; inset: 0; border-radius: 10px; background: var(--toggle-off); transition: background .25s; }
    .h-toggle input:checked + .h-track { background: #34c759; }
    .h-toggle .h-thumb { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 50%; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,.2); transition: transform .25s; }
    .h-toggle input:checked ~ .h-thumb { transform: translateX(16px); }
    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #0f172a; --bg-card: #1e293b; --bg-surface: #162032;
        --bg-tab-bar: #1e293b; --bg-input: #162032;
        --border-color: #334155; --border-light: #253449; --input-border: #334155;
        --divider-color: #253449;
        --shadow: rgba(0,0,0,.3); --shadow-sm: 0 1px 4px rgba(0,0,0,.3); --shadow-md: 0 4px 16px rgba(0,0,0,.4);
        --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #64748b; --text-tertiary: #475569;
        --toggle-off: #334155; --brand-soft: rgba(232,68,26,.15);
      }
    }
    .homey-dark-mode {
      --bg-body: #0f172a; --bg-card: #1e293b; --bg-surface: #162032;
      --bg-tab-bar: #1e293b; --bg-input: #162032;
      --border-color: #334155; --border-light: #253449; --input-border: #334155;
      --divider-color: #253449;
      --shadow: rgba(0,0,0,.3); --shadow-sm: 0 1px 4px rgba(0,0,0,.3); --shadow-md: 0 4px 16px rgba(0,0,0,.4);
      --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #64748b; --text-tertiary: #475569;
      --toggle-off: #334155; --brand-soft: rgba(232,68,26,.15);
    }
  </style>
</head>
<body>
<div class="container">

<div class="header-top">
  <div class="header-title">
    <h1>Power <span>Guard</span></h1>
    <p class="subtitle">Automatically turns off devices before you exceed your power limit.</p>
  </div>
</div>

  <div id="error-banner"></div>
  <div id="loading-indicator">Connecting to Homey…</div>

  <!-- Token fallback card -->
  <div class="card" id="connect-card">
    <h2>Connect to Homey API</h2>
    <div class="steps">
      Power Guard needs a Personal Access Token to read and save settings.<br>
      <b>1.</b> Go to <b>my.homey.app</b> → your name → <b>Account</b> → <b>Security</b> → <b>Personal Access Tokens</b><br>
      <b>2.</b> Create a new token with scope <b>homey:manager:api</b><br>
      <b>3.</b> Paste it below (held in memory only for this session).
    </div>
    <div id="token-row">
      <input type="password" id="token-input" placeholder="pat-apps-…" autocomplete="off">
      <button class="btn-primary" onclick="connectWithToken()">Connect</button>
    </div>
    <div id="connect-error"></div>
  </div>

  <!-- Main content -->
  <div id="main-content" style="display:none">

    <!-- Tab bar -->
    <div class="tab-bar">
      <button class="tab-btn active" id="tb-settings" onclick="showTab('settings')"><span class="tab-icon">⚙️</span><span class="tab-label">Settings</span></button>
      <button class="tab-btn"        id="tb-devices"  onclick="showTab('devices')"><span class="tab-icon">📱</span><span class="tab-label">Devices</span></button>
      <button class="tab-btn"        id="tb-system"   onclick="showTab('system')"><span class="tab-icon">📊</span><span class="tab-label">System</span></button>
      <button class="tab-btn"        id="tb-consumption" onclick="showTab('consumption')"><span class="tab-icon">⚡</span><span class="tab-label">Power</span></button>
      <button class="tab-btn"        id="tb-floorheater" onclick="showTab('floorheater')"><span class="tab-icon">🌡️</span><span class="tab-label">Heaters</span></button>
      <button class="tab-btn"        id="tb-log"         onclick="showTab('log')"><span class="tab-icon">📋</span><span class="tab-label">Log</span></button>
    </div>

    <!-- ── Settings tab ──────────────────────────────────────────────────── -->
    <div id="tab-settings">

      <div class="card">
        <h2>Current Status</h2>
        <div class="status-grid">
          <div class="stat-box">
            <div class="stat-label">Power right now</div>
            <div class="stat-value" id="st-power">– W</div>
            <div class="stat-sub">of <span id="st-limit">–</span> W limit</div>
          </div>
          <div class="stat-box">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;width:100%">
              <div>
                <div class="stat-label">Guard is active</div>
                <div class="stat-value" id="st-enabled-big">–</div>
                <div class="stat-sub" id="st-profile-sub">–</div>
              </div>
              <label class="toggle" id="guard-toggle" style="margin: 0;flex-shrink:0;margin-top:2px">
                <input type="checkbox" id="s-enabled-toggle" onchange="updateEnabledSync(this.checked)">
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Power meter</div>
            <div class="stat-value" id="st-han" style="font-size:14px;padding-top:4px">–</div>
            <div class="stat-sub" id="st-han-age" style="font-size:10px;color:#8e8e93"></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Devices controlled</div>
            <div class="stat-value" id="st-mitigation">–</div>
          </div>
        </div>
        <div id="ev-section" style="display:none;margin-top:14px">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;font-weight:500">EV CHARGERS</div>
          <div id="ev-grid" class="status-grid"></div>
        </div>
        <div style="margin-top:14px">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;font-weight:500">RECENT ACTIVITY</div>
          <div id="log-container"><div class="log-entry" style="color:var(--text-tertiary)">No activity yet.</div></div>
        </div>
        <div style="margin-top:14px">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;font-weight:500">LAST MITIGATION SCAN</div>
          <div id="scan-container"><div class="log-entry" style="color:var(--text-tertiary)">No scan data yet.</div></div>
        </div>
        <!-- Effekttariff (Capacity Tariff) Section -->
        <div style="margin-top:14px" id="effekt-section">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;font-weight:500">⚡ EFFEKTTARIFF (TEST)</div>
          <div id="effekt-container" style="background:var(--bg-surface);border-radius:8px;padding:10px;">
            <div style="color:var(--text-tertiary);font-size:12px">Waiting for data...</div>
          </div>
        </div>
        <!-- Hidden sync element for s-enabled -->
        <input type="checkbox" id="s-enabled" style="display:none" onchange="syncEnabledCheckbox()" checked>
      </div>

      <div class="card">
        <div class="row">
          <div class="label-group">
            <label>Protection mode</label>
            <span class="hint"><b>Normal</b> — full limit. &nbsp;<b>Strict</b> — 90% of limit.</span>
          </div>
          <div class="control">
            <select id="s-profile">
              <option value="normal">Normal</option>
              <option value="strict">Strict</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Power Limit</h2>
        <div class="row">
          <div class="label-group">
            <label>Maximum power (W)</label>
            <span class="hint">Your grid connection limit. Typical: 10 000 W (10 kW) or 15 000 W (15 kW).</span>
          </div>
          <div class="control">
            <input type="number" id="s-powerLimitW" min="100" max="100000" step="500" value="10000">
            <span style="font-size:12px;color:var(--text-muted)">W</span>
          </div>
        </div>
        <div class="row">
          <div class="label-group">
            <label>Time before acting (s)</label>
            <span class="hint">How long the limit must be exceeded before turning off a device.</span>
          </div>
          <div class="control">
            <input type="number" id="s-cooldownSeconds" min="5" max="300" step="5" value="30">
            <span style="font-size:12px;color:var(--text-muted)">s</span>
          </div>
        </div>
        <div class="advanced-toggle" onclick="toggleAdvanced()">
          <span id="adv-arrow">&#9654;</span> Advanced settings
        </div>
        <div id="advanced-section">
          <div class="row" style="padding-top:12px">
            <div class="label-group"><label>Phase 1 limit (A)</label><span class="hint">0 = disabled</span></div>
            <div class="control"><input type="number" id="s-phase1LimitA" min="0" max="63" step="1" value="0"><span style="font-size:12px;color:var(--text-muted)">A</span></div>
          </div>
          <div class="row">
            <div class="label-group"><label>Phase 2 limit (A)</label></div>
            <div class="control"><input type="number" id="s-phase2LimitA" min="0" max="63" step="1" value="0"><span style="font-size:12px;color:var(--text-muted)">A</span></div>
          </div>
          <div class="row">
            <div class="label-group"><label>Phase 3 limit (A)</label></div>
            <div class="control"><input type="number" id="s-phase3LimitA" min="0" max="63" step="1" value="0"><span style="font-size:12px;color:var(--text-muted)">A</span></div>
          </div>
          <div class="row">
            <div class="label-group"><label>Reaction speed</label><span class="hint">Readings to average. Lower = faster.</span></div>
            <div class="control">
              <input type="range" id="s-smoothingWindow" min="1" max="20" step="1" value="5">
              <span class="range-val" id="v-smoothingWindow">5</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Spike ignore threshold</label><span class="hint">Readings × avg before ignoring as a spike.</span></div>
            <div class="control">
              <input type="range" id="s-spikeMultiplier" min="1.2" max="5.0" step="0.1" value="2.0">
              <span class="range-val" id="v-spikeMultiplier">2.0×</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Confirm before acting</label><span class="hint">High readings in a row before switching off.</span></div>
            <div class="control">
              <input type="range" id="s-hysteresisCount" min="1" max="10" step="1" value="3">
              <span class="range-val" id="v-hysteresisCount">3</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Safety buffer</label><span class="hint">Reduce effective limit by this % (e.g. 5% on 10 kW acts at 9.5 kW). </span></div>
            <div class="control">
              <input type="range" id="s-errorMarginPercent" min="0" max="20" step="1" value="0"
                oninput="document.getElementById('v-errorMarginPercent').textContent=this.value+'%'">
              <span class="range-val" id="v-errorMarginPercent">0%</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Missing data timeout</label><span class="hint">Force mitigation if no power reading for this many seconds. 0 = disabled.</span></div>
            <div class="control">
              <input type="number" id="s-missingPowerTimeoutS" min="0" max="600" step="30" value="120">
              <span style="font-size:12px;color:var(--text-muted)">s</span>
            </div>
          </div>
          <div class="row">
            <div class="label-group"><label>Dynamic restore guard</label><span class="hint">Wait 1–5 min after turning a device off before restoring. Longer waits when more of the hour remains. Prevents rapid cycling.</span></div>
            <div class="control"><input type="checkbox" id="s-dynamicRestoreGuard" checked></div>
          </div>
        </div>
      </div>

      <div class="save-row">
        <button class="btn-secondary" onclick="loadAll()">Discard</button>
        <button class="btn-primary"   onclick="saveAll()">Save settings</button>
      </div>



    </div><!-- /#tab-settings -->

    <!-- ── System tab ────────────────────────────────────────────────────── -->
    <div id="tab-system" style="display:none">

      <div class="card">
        <h2>Power Meter Selection</h2>
        <div class="row">
          <div class="label-group">
            <label>Power meter device</label>
            <span class="hint">Select which device to use for live power monitoring. "Auto-detect" finds HAN meters automatically.</span>
          </div>
          <div class="control">
            <select id="s-meterDevice" onchange="changeMeterDevice(this.value)" style="min-width:180px">
              <option value="auto">Auto-detect</option>
            </select>
          </div>
        </div>
        <div id="meter-status" style="font-size:12px;color:var(--text-muted);margin-top:6px"></div>
      </div>

      <div class="card">
        <h2>HAN Meter Diagnostics</h2>
        <div id="han-diag-content" style="font-size:12px;">
          <span style="color:var(--text-muted)">Loading...</span>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="btn-secondary" onclick="loadHanDiagnostic()" style="font-size:12px; padding:5px 12px;">Refresh</button>
          <button class="btn-secondary" onclick="copyHanDiagnostic()" style="font-size:12px; padding:5px 12px;">Copy diagnostic JSON</button>
        </div>
        <div id="han-diag-copy-msg" style="font-size:11px; margin-top:4px; display:none;"></div>
      </div>

      <div class="card">
        <h2>Electrical System Configuration</h2>
        <div class="row">
          <div class="label-group">
            <label>Main circuit voltage</label>
            <span class="hint">Select your electrical system type. This affects power calculations for EV charger control.</span>
          </div>
          <div class="control">
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
              <select id="s-voltageSystem">
                <option value="auto">✨ Auto-detect from HAN sensor</option>
                <option value="230v-1phase">230V Single-phase</option>
                <option value="400v-3phase">400V Three-phase</option>
              </select>
              <div id="voltage-detected-badge" style="font-size:11px; color:var(--text-muted);"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Managed Chargers</h2>
        <div class="row" style="margin-bottom:12px;">
          <div class="label-group">
            <label>Circuit breaker (total)</label>
            <span class="hint">Physical fuse for the whole EV circuit. The per-charger Max Current below cannot exceed this.</span>
          </div>
          <div class="control">
            <input type="number" id="s-mainCircuitA" min="10" max="100" step="1" value="25">
            <span style="font-size:12px;color:var(--text-muted)">A</span>
          </div>
        </div>
        <div id="charger-details-list" style="font-size:12px;">
          <span style="color:var(--text-muted)">⏳ Loading chargers...</span>
        </div>

        <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border-color);">
          <button class="btn-primary" onclick="syncChargerLimitsFromDevices()" style="font-size:12px; padding:6px 14px;">
            📥 Sync from charger
          </button>
          <button class="btn-secondary" onclick="testChargerControl()" style="font-size:12px; padding:6px 14px; margin-left:6px;">
            🔌 Test charger control
          </button>
          <button class="btn-secondary" onclick="showDiagnostics()" style="font-size:12px; padding:6px 14px; margin-left:6px;">
            🔍 Diagnostics
          </button>
          <div id="charger-sync-msg" style="margin-top:6px; font-size:11px; color:var(--text-muted); display:none;"></div>
          <div id="charger-test-result" style="margin-top:8px; font-size:12px; display:none;"></div>
        </div>
      </div>

      <div class="save-row">
        <button class="btn-secondary" onclick="loadAll()">Discard</button>
        <button class="btn-primary"   onclick="saveAll()">Save</button>
      </div>

    </div><!-- /#tab-system -->
    <div id="tab-consumption" style="display:none">

      <div class="card">
        <h2>Power Consumption by Device</h2>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">
          📊 <strong>Read-only monitoring.</strong> This tab shows live power readings from all your Homey devices. It has no effect on the system — nothing here controls or changes any device.
        </div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;font-weight:500">
          Filter by device type
        </div>
        <div id="device-type-filters" style="display:flex;flex-wrap:wrap;gap:14px;margin-bottom:14px;">
          <!-- Filters will be populated here -->
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <thead style="border-bottom:2px solid var(--border-color);">
            <tr>
              <th style="text-align:left;padding:8px 0;color:var(--text-muted);font-weight:500;">Device</th>
              <th style="text-align:right;padding:8px 0;color:var(--text-muted);font-weight:500;">Current</th>
              <th style="text-align:right;padding:8px 0;color:var(--text-muted);font-weight:500;">Avg</th>
              <th style="text-align:right;padding:8px 0;color:var(--text-muted);font-weight:500;">Peak</th>
              <th style="text-align:right;padding:8px 0;color:var(--text-muted);font-weight:500;">Share</th>
            </tr>
          </thead>
          <tbody id="consumption-table">
            <tr>
              <td colspan="5" style="text-align:center;padding:24px;color:var(--text-tertiary);">Loading...</td>
            </tr>
          </tbody>
        </table>
        <div style="font-size:11px;color:var(--text-tertiary);margin-top:12px;text-align:right;">
          Last updated: <span id="consumption-time">–</span>
        </div>
      </div>

    </div><!-- /#tab-consumption -->

    <!-- ── Floor Heater Check tab ────────────────────────────────────────── -->
    <div id="tab-floorheater" style="display:none">

      <div class="card" style="padding-bottom:8px;">
        <div style="margin-bottom:10px;">
          <h2 style="margin:0 0 2px;">Thermostats</h2>
          <div style="font-size:11px;color:var(--text-muted);"><span id="floorheater-count">–</span> found · auto-refreshes</div>
        </div>
        <div id="floorheater-list" class="heater-list">
          <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;">Loading…</div>
        </div>
      </div>

    </div><!-- /#tab-floorheater -->

    <!-- ── Log tab ──────────────────────────────────────────────────────── -->
    <div id="tab-log" style="display:none">

      <div class="card">
        <h2>Diagnostic Log</h2>
        <p style="font-size:12px; color:var(--text-muted); margin:0 0 12px 0;">
          Consolidated diagnostic log for remote debugging. Use filter buttons to view specific categories, and copy buttons to share data.
        </p>

        <!-- Filter buttons -->
        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px;">
          <button class="btn-secondary log-filter-btn active" data-filter="all" onclick="filterAppLog('all')" style="font-size:11px; padding:4px 10px;">All</button>
          <button class="btn-secondary log-filter-btn" data-filter="han" onclick="filterAppLog('han')" style="font-size:11px; padding:4px 10px; border-left:3px solid #34c759;">HAN</button>
          <button class="btn-secondary log-filter-btn" data-filter="charger" onclick="filterAppLog('charger')" style="font-size:11px; padding:4px 10px; border-left:3px solid #007aff;">Charger</button>
          <button class="btn-secondary log-filter-btn" data-filter="mitigation" onclick="filterAppLog('mitigation')" style="font-size:11px; padding:4px 10px; border-left:3px solid #ff9500;">Mitigation</button>
          <button class="btn-secondary log-filter-btn" data-filter="energy" onclick="filterAppLog('energy')" style="font-size:11px; padding:4px 10px; border-left:3px solid #af52de;">Energy</button>
          <button class="btn-secondary log-filter-btn" data-filter="cache" onclick="filterAppLog('cache')" style="font-size:11px; padding:4px 10px; border-left:3px solid #5ac8fa;">Cache</button>
          <button class="btn-secondary log-filter-btn" data-filter="system" onclick="filterAppLog('system')" style="font-size:11px; padding:4px 10px; border-left:3px solid #8e8e93;">System</button>
        </div>

        <!-- Copy and auto-refresh controls -->
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; align-items:center;">
          <button class="btn-secondary" onclick="copyAppLog('filtered')" style="font-size:11px; padding:4px 10px;">Copy Filtered</button>
          <button class="btn-secondary" onclick="copyAppLog('all')" style="font-size:11px; padding:4px 10px;">Copy All JSON</button>
          <button class="btn-secondary" onclick="loadAppLog()" style="font-size:11px; padding:4px 10px;">Refresh</button>
          <label style="font-size:11px; color:var(--text-muted); display:flex; align-items:center; gap:4px; margin-left:auto;">
            <input type="checkbox" id="log-auto-refresh" onchange="toggleLogAutoRefresh(this.checked)"> Auto-refresh (5s)
          </label>
        </div>

        <div id="log-copy-msg" style="font-size:11px; margin-bottom:8px; display:none;"></div>

        <!-- App log entries -->
        <div id="app-log-entries" style="font-family:monospace; font-size:11px; background:var(--bg-surface); border-radius:8px; padding:10px; max-height:400px; overflow-y:auto; white-space:pre-wrap; word-break:break-all;">
          <span style="color:var(--text-muted)">Loading log data...</span>
        </div>
      </div>

      <!-- HAN Diagnostic Summary -->
      <div class="card">
        <h2>HAN Meter Summary</h2>
        <div id="log-han-summary" style="font-size:12px;">
          <span style="color:var(--text-muted)">Loading...</span>
        </div>
        <div style="margin-top:8px;">
          <button class="btn-secondary" onclick="copyAppLog('han-diagnostic')" style="font-size:11px; padding:4px 10px;">Copy HAN Diagnostic JSON</button>
        </div>
      </div>

      <!-- Mitigation Scan Results -->
      <div class="card">
        <h2>Last Mitigation Scan</h2>
        <div id="log-mitigation-scan" style="font-size:12px;">
          <span style="color:var(--text-muted)">Loading...</span>
        </div>
        <div style="margin-top:8px;">
          <button class="btn-secondary" onclick="copyAppLog('mitigation-scan')" style="font-size:11px; padding:4px 10px;">Copy Mitigation Scan JSON</button>
        </div>
      </div>

      <!-- System Info -->
      <div class="card">
        <h2>System Info</h2>
        <div id="log-system-info" style="font-size:12px;">
          <span style="color:var(--text-muted)">Loading...</span>
        </div>
        <div style="margin-top:8px;">
          <button class="btn-secondary" onclick="copyAppLog('system-info')" style="font-size:11px; padding:4px 10px;">Copy System Info JSON</button>
        </div>
      </div>

      <!-- Device Firmware Info -->
      <div class="card">
        <h2>Device Firmware Info</h2>
        <p style="font-size:12px; color:var(--text-muted); margin:0 0 10px 0;">Search devices by name or driver to read their firmware version from Homey.</p>
        <div style="display:flex; gap:8px; margin-bottom:10px; align-items:center;">
          <input type="text" id="firmware-search" placeholder="e.g. namron, dimmer…" style="flex:1; font-size:12px; padding:6px 10px; border:1px solid var(--border-color); border-radius:6px; background:var(--bg-surface); color:var(--text-primary);" onkeydown="if(event.key==='Enter') loadFirmwareInfo()">
          <button class="btn-secondary" onclick="loadFirmwareInfo()" style="font-size:12px; padding:6px 14px;">Search</button>
        </div>
        <div id="firmware-results" style="font-size:12px; color:var(--text-muted);">Enter a search term above and click Search.</div>
      </div>

    </div><!-- /#tab-log -->

    <!-- ── Devices tab ───────────────────────────────────────────────────── -->
    <div id="tab-devices" style="display:none">

      <div class="card">
        <div id="cache-status" style="font-size:12px; color:var(--text-muted); margin-bottom:12px; padding: 8px; background:var(--bg-surface); border-radius:8px;">
          <span id="cache-loading" style="color:var(--text-muted)">⏳ Loading devices...</span>
          <span id="cache-status-text" style="display:none; color:#34c759">✓</span>
          <span id="cache-refresh-btn" style="display:none; margin-left:12px;">
            <button class="btn-small btn-secondary" onclick="refreshDeviceCache()" style="padding:4px 10px; font-size:11px;">Refresh</button>
          </span>
        </div>

        <h2>Device priority</h2>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:4px;line-height:1.5">
          Toggle a device <b>on</b> to let Power Guard control it. Drag &#9776; to set the order —
          devices higher in the list are turned off first.
        </p>
        <div id="devices-list"></div>
      </div>

      <div class="save-row">
        <span id="dev-save-status" style="font-size:12px;color:var(--text-muted);margin-right:auto"></span>
        <button class="btn-secondary" onclick="loadAll()">Discard</button>
        <button class="btn-primary"   onclick="saveAll()">Save</button>
      </div>

    </div><!-- /#tab-devices -->

  </div><!-- /#main-content -->
</div>

<div id="toast">Settings saved!</div>

<!-- Debug log panel -->
<div id="debug-panel" style="position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;background:#1a1a2e;color:#0f0;font-family:monospace;font-size:11px;padding:8px 12px;z-index:9999;display:none;border-top:2px solid #e8441a;">
  <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
    <b style="color:#e8441a;">DEBUG LOG</b>
    <span>
      <button onclick="document.getElementById('debug-log').innerHTML=''" style="font-size:10px;padding:2px 8px;cursor:pointer;">Clear</button>
      <button onclick="document.getElementById('debug-panel').style.display='none'" style="font-size:10px;padding:2px 8px;cursor:pointer;">Hide</button>
    </span>
  </div>
  <div id="debug-log"></div>
</div>

<script>
  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 1 — CORE INFRASTRUCTURE                              ██
  // ══════════════════════════════════════════════════════════════════
  //  a. Dark mode       — CSS-only (no JS needed)
  //  b. dbg()           — debug logging helper
  //  c. State vars      — priorityList, availableDevices, _last* caches
  //  d. hApi()          — Homey API promise wrapper
  //  e. savePriorityList() — POST priority list back to app
  //  f. UI helpers      — showError, showToast, escHtml, showTab,
  //                       toggleAdvanced, showMain, showConnectCard
  //
  //  ✅ STABLE — core plumbing, rarely needs touching
  // ══════════════════════════════════════════════════════════════════

  // ── Dark mode ──────────────────────────────────────────────────────────────
  // All dark mode is handled in CSS only:
  //   1. @media (prefers-color-scheme: dark) — OS-level dark mode
  //   2. .homey-dark-mode selector — Homey's injected dark mode class
  // No JavaScript needed.

  // ── Debug logging ──────────────────────────────────────────────────────────
  function dbg(msg) {
    // Debug panel disabled — re-enable by changing display:none to display:block on #debug-panel
    return;
  }

  // ── State ──────────────────────────────────────────────────────────────────
  var _H              = null;
  var priorityList    = [];
  var availableDevices = [];
  var _detectedVoltageSystem = '230v-1phase';  // filled from API on load
  var _lastChargerStatus = {};  // deviceId → { status, statusLabel, currentA, powerW }
  var _lastChargerLimits = {};   // deviceId → { maxCurrent (ID47), dynamic_charger_current (ID48), circuit_current, mitigated, allValues }
  var _mitigatedDeviceIds = {};  // deviceId → true when Power Guard is controlling a device
  var _touchDragIdx   = null;
  var _touchTargetIdx = null;
  var _touchDragLi    = null;
  var _heaterFocusId  = null;
  var _heaterDirty    = {};  // deviceId → edited temp value

  // ── Homey.api() wrappers (return Promises) ────────────────────────────────
  // Per official docs: Homey.api(method, path, body, callback)
  // Callback signature: function(err, result)

  function hApi(method, path, body) {
    return new Promise(function(resolve, reject) {
      _H.api(method, path, body, function(err, result) {
        if (err) {
          dbg('<span style="color:red">' + method + ' ' + path + ' error: ' + (err.message || err) + '</span>');
          reject(err);
        } else {
          dbg(method + ' ' + path + ' OK');
          resolve(result);
        }
      });
    });
  }

  // ── Priority list persistence ─────────────────────────────────────────────
  function savePriorityList() {
    if (!_H) return;
    hApi('POST', '/priority-list', priorityList)
      .then(function() { dbg('Priority list saved'); })
      .catch(function(e) { dbg('Priority save error: ' + e.message); });
  }

  // ── UI helpers ─────────────────────────────────────────────────────────────
  function showError(msg)  { var e = document.getElementById('error-banner'); e.textContent = msg; e.style.display = 'block'; }
  function clearError()    { document.getElementById('error-banner').style.display = 'none'; }
  function showToast()     { var t = document.getElementById('toast'); t.style.display = 'block'; setTimeout(function() { t.style.display = 'none'; }, 2500); }
  function escHtml(s)      { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function toggleAdvanced() {
    var s = document.getElementById('advanced-section'), a = document.getElementById('adv-arrow');
    if (s.style.display === 'none' || !s.style.display) { s.style.display = 'block'; a.innerHTML = '&#9660;'; }
    else { s.style.display = 'none'; a.innerHTML = '&#9654;'; }
  }

  function showTab(name) {
    ['settings','system','devices','consumption','floorheater','log'].forEach(function(t) {
      document.getElementById('tab-' + t).style.display  = t === name ? 'block' : 'none';
      document.getElementById('tb-'  + t).classList[t === name ? 'add' : 'remove']('active');
    });
    if (name === 'consumption') {
      // Load settings first to restore filters, then load consumption data
      hApi('GET', '/all', null)
        .then(function(data) {
          var settings = data.settings || {};
          if (settings.classFilters && typeof settings.classFilters === 'object') {
            _classFilters = settings.classFilters;
          }
          loadConsumption();
        })
        .catch(function(err) {
          loadConsumption(); // Load consumption anyway if settings fail
        });
    } else if (name === 'floorheater') {
      loadFloorHeaters();
    } else if (name === 'log') {
      loadAppLog();
    } else {
      loadAll();
    }
  }

  function showMain() {
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('connect-card').style.display     = 'none';
    document.getElementById('main-content').style.display     = 'block';
  }
  function showConnectCard() {
    document.getElementById('loading-indicator').style.display = 'none';
    document.getElementById('connect-card').style.display     = 'block';
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 2 — STATUS DASHBOARD                                 ██
  // ══════════════════════════════════════════════════════════════════
  //  a. updateStatusUI()  — renders live power / mitigation panel
  //                         (wattage, device states, over-limit badge)
  //
  //  🔵 ACTIVE — updated every poll cycle
  // ══════════════════════════════════════════════════════════════════

  // ── Status UI ──────────────────────────────────────────────────────────────
  var _lastPowerW = null;

  function updateStatusUI(s) {
    if (!s) return;
    var powerEl = document.getElementById('st-power');
    var newPower = Math.round(s.currentPowerW || 0);
    powerEl.textContent = newPower + ' W';
    // Flash power value green briefly when it changes
    if (_lastPowerW !== null && _lastPowerW !== newPower) {
      powerEl.style.transition = 'none';
      powerEl.style.color = '#34c759';
      setTimeout(function() {
        powerEl.style.transition = 'color 1s ease';
        powerEl.style.color = '';
      }, 50);
    }
    _lastPowerW = newPower;
    document.getElementById('st-limit').textContent       = Math.round(s.limitW || 0);
    document.getElementById('st-enabled-big').textContent = s.enabled ? 'ON' : 'OFF';
    document.getElementById('st-enabled-big').style.color = s.enabled ? '#34c759' : '#ff9500';
    document.getElementById('st-profile-sub').textContent =
      ({ normal: 'Normal mode', strict: 'Strict mode', solar: 'Solar-friendly' }[s.profile] || '');
    var h = document.getElementById('st-han');
    if (s.hanConnected) {
      h.textContent = 'Connected';
      h.style.color = '#34c759';
    } else {
      h.textContent = 'Not found';
      h.style.color = '#ff3b30';
    }
    // Show device brand and reading age
    var hanAge = document.getElementById('st-han-age');
    if (hanAge && s.hanLastSeen) {
      var ageSec = Math.round((Date.now() - s.hanLastSeen) / 1000);
      var ageText = ageSec < 5 ? 'Live' : ageSec < 60 ? ageSec + 's ago' : Math.round(ageSec / 60) + 'm ago';
      if (s.hanDeviceName) {
        hanAge.textContent = s.hanDeviceName + ' (' + ageText + ')';
      } else {
        hanAge.textContent = ageText;
      }
      hanAge.style.color = ageSec < 10 ? '#34c759' : ageSec < 30 ? '#ff9500' : '#ff3b30';
    } else if (hanAge) {
      hanAge.textContent = s.hanDeviceName || (s.hanConnected ? '' : 'No readings');
      hanAge.style.color = s.hanConnected ? 'var(--text-muted)' : '#ff3b30';
    }
    var n = (s.mitigatedDevices || []).length;
    var m = document.getElementById('st-mitigation');
    m.textContent = n || 'None';
    m.style.color = n > 0 ? '#ff9500' : '#34c759';
    // Track which devices are currently controlled for the Devices tab highlighting
    var prevIds = JSON.stringify(_mitigatedDeviceIds);
    _mitigatedDeviceIds = {};
    (s.mitigatedDevices || []).forEach(function(md) {
      _mitigatedDeviceIds[md.deviceId] = md.action || true;
    });
    // Re-render device list if the set of controlled devices changed
    if (JSON.stringify(_mitigatedDeviceIds) !== prevIds) {
      renderAllDevices();
    }
    var entries = (s.log || []).slice().reverse().slice(0, 8);
    document.getElementById('log-container').innerHTML = entries.length
      ? entries.map(function(e) {
          return '<div class="log-entry"><span class="log-time">' +
            (e.time ? new Date(e.time).toLocaleTimeString() : '') + '</span>' +
            escHtml(e.message || '') + '</div>';
        }).join('')
      : '<div class="log-entry" style="color:var(--text-tertiary)">No activity yet.</div>';
    // Render last mitigation scan diagnostics
    var scanData = Array.isArray(s.lastMitigationScan) ? s.lastMitigationScan : [];
    document.getElementById('scan-container').innerHTML = scanData.length
      ? scanData.map(function(d) {
          var color = d.result === 'SUCCESS' ? '#34c759' :
                      d.result.indexOf('already mitigated') >= 0 ? '#ff9500' :
                      d.result.indexOf('error') >= 0 ? '#ff3b30' : 'var(--text-secondary)';
          return '<div class="log-entry"><span style="color:' + color + '">' +
            escHtml(d.name || '?') + '</span> [' + escHtml(d.action || '?') + '] → ' +
            escHtml(d.result || '?') + '</div>';
        }).join('')
      : '<div class="log-entry" style="color:var(--text-tertiary)">No scan data yet.</div>';
    var evChargers = Array.isArray(s.evChargers) ? s.evChargers : [];
    // Update cached charger status for the System tab table
    evChargers.forEach(function(c) {
      if (c.deviceId) {
        _lastChargerStatus[c.deviceId] = {
          status: c.status || 'charging',
          statusLabel: c.statusLabel || 'Charging',
          currentA: c.currentA || 0,
          powerW: c.powerW || 0,
          chargerStatus: c.chargerStatus,
          isCharging: c.isCharging,
          confirmed: c.confirmed || false,
          reliability: c.reliability != null ? c.reliability : 50,
          offeredCurrent: c.offeredCurrent
        };
        // Live-update the status badge in the System tab table without full re-render
        var badge = document.getElementById('charger-status-' + c.deviceId);
        if (badge) {
          var color = c.status === 'paused' ? '#ff3b30' :
                     c.status === 'dynamic' ? '#ff9500' :
                     c.status === 'charging' ? '#34c759' :
                     c.status === 'waiting' ? '#007aff' :
                     c.status === 'completed' ? '#34c759' :
                     c.status === 'connected' ? 'var(--text-muted)' : '#8e8e93';
          var icon = c.status === 'paused' ? '\u23f8' :
                    c.status === 'dynamic' ? '\u26a1' :
                    c.status === 'charging' ? '\ud83d\udd0b' :
                    c.status === 'waiting' ? '\u23f3' :
                    c.status === 'completed' ? '\u2705' :
                    c.status === 'connected' ? '\ud83d\udd0c' : '\u2796';
          badge.style.color = color;
          badge.textContent = icon + ' ' + (c.statusLabel || 'Idle');
        }
      }
    });
    var evSection = document.getElementById('ev-section');
    var evGrid = document.getElementById('ev-grid');
    if (evSection && evGrid) {
      if (evChargers.length) {
        evSection.style.display = 'block';
        evGrid.innerHTML = evChargers.map(function(c) {
          var statusColor = c.status === 'paused' ? '#ff3b30' :
                           c.status === 'dynamic' ? '#ff9500' :
                           c.status === 'charging' ? '#34c759' :
                           c.status === 'waiting' ? '#007aff' :
                           c.status === 'completed' ? '#34c759' :
                           c.status === 'connected' ? 'var(--text-muted)' : '#8e8e93';
          return '<div class="stat-box">'  +
            '<div class="stat-label">' + escHtml(c.name || 'EV Charger') + '</div>' +
            '<div class="stat-value">' + Math.round(c.powerW || 0) + ' W</div>' +
            '<div class="stat-sub" style="color:' + statusColor + '">' + escHtml(c.statusLabel || 'Idle') + '</div>' +
            '</div>';
        }).join('');
      } else {
        evSection.style.display = 'none';
      }
    }

    // Render effekttariff section
    var effekt = s.effekttariff;
    var effektEl = document.getElementById('effekt-container');
    if (effektEl && effekt) {
      var tierColor = effekt.tierIndex <= 1 ? '#34c759' :
                      effekt.tierIndex <= 3 ? '#ff9500' : '#ff3b30';
      var peakWarning = effekt.wouldBeNewDailyPeak
        ? '<span style="color:#ff9500;font-weight:600"> ⚠ New peak!</span>' : '';
      var html = '';
      // Main metric
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
      html += '<div>';
      html += '<div style="font-size:11px;color:var(--text-muted);margin-bottom:2px">Monthly metric (TOP3 avg)</div>';
      html += '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + effekt.monthlyKW.toFixed(1) + ' <span style="font-size:13px;font-weight:400">kW</span></div>';
      html += '</div>';
      html += '<div style="text-align:right">';
      html += '<div style="font-size:11px;color:var(--text-muted);margin-bottom:2px">Current tier</div>';
      html += '<div style="font-size:16px;font-weight:600;color:' + tierColor + '">' + escHtml(effekt.tierLabel) + '</div>';
      html += '</div>';
      html += '</div>';

      // Current hour info
      html += '<div style="display:flex;gap:16px;margin-bottom:8px;padding:6px 0;border-top:1px solid var(--border-color);font-size:12px">';
      html += '<div>This hour: <b>' + effekt.currentHourKWh.toFixed(2) + ' kWh</b> → projected <b>' + effekt.projectedKWh.toFixed(2) + ' kW</b>' + peakWarning + '</div>';
      html += '<div>Today peak: <b>' + effekt.todayPeakKW.toFixed(2) + ' kW</b></div>';
      html += '</div>';

      // TOP3 days
      if (effekt.top3 && effekt.top3.length) {
        html += '<div style="border-top:1px solid var(--border-color);padding-top:6px;font-size:11px;color:var(--text-muted);margin-bottom:4px">Top 3 daily peaks this month:</div>';
        html += '<div style="font-size:12px">';
        effekt.top3.forEach(function(p, i) {
          var medal = i === 0 ? '🥇' : i === 1 ? '🥈' : '🥉';
          html += '<div style="padding:2px 0">' + medal + ' ' + p.date + ' — <b>' + p.kw.toFixed(2) + ' kW</b></div>';
        });
        html += '</div>';
      }

      // All peaks (collapsed)
      if (effekt.allPeaks && effekt.allPeaks.length > 3) {
        html += '<details style="margin-top:6px;font-size:11px"><summary style="cursor:pointer;color:var(--text-muted)">All daily peaks (' + effekt.dailyPeakCount + ' days)</summary>';
        html += '<div style="margin-top:4px">';
        effekt.allPeaks.forEach(function(p) {
          html += '<div style="padding:1px 0;color:var(--text-secondary)">' + p.date + ': ' + p.kw.toFixed(2) + ' kW</div>';
        });
        html += '</div></details>';
      }

      // Note that this is test mode
      html += '<div style="margin-top:8px;padding:6px 8px;background:var(--bg-body);border-radius:6px;font-size:11px;color:var(--text-muted)">';
      html += '🧪 <b>Test mode</b> — Display only. Not affecting limits or mitigation.';
      html += '</div>';
      effektEl.innerHTML = html;
    }
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 3 — SETTINGS (Load / Save / Apply)                   ██
  // ══════════════════════════════════════════════════════════════════
  //  a. applySettings()       — push API data into form fields
  //  b. setNum() / setRange() — form field helpers
  //  c. updatePhaseConfigVisibility() — show/hide 3-phase options
  //  d. loadAll()             — fetch all settings + charger status
  //  e. collectSettings()     — read form → settings object
  //  f. saveAll()             — persist settings + push circuit limits
  //
  //  ✅ STABLE
  // ══════════════════════════════════════════════════════════════════

  // ── Apply settings to form ─────────────────────────────────────────────────
  function applySettings(s) {
    if (!s) return;
    document.getElementById('s-enabled').checked = s.enabled !== false;
    document.getElementById('s-enabled-toggle').checked = s.enabled !== false;
    document.getElementById('s-profile').value   = s.profile || 'normal';
    document.getElementById('s-voltageSystem').value = s.voltageSystem || 'auto';
    _updateVoltageDetectedBadge();
    setNum('s-powerLimitW',     s.powerLimitW,    10000);
    setNum('s-cooldownSeconds', s.cooldownSeconds, 30);
    setNum('s-phase1LimitA',    s.phase1LimitA,   0);
    setNum('s-phase2LimitA',    s.phase2LimitA,   0);
    setNum('s-phase3LimitA',    s.phase3LimitA,   0);
    setNum('s-mainCircuitA',    s.mainCircuitA,   25);
    setRange('s-smoothingWindow', 'v-smoothingWindow', s.smoothingWindow, 5,   '');
    setRange('s-spikeMultiplier', 'v-spikeMultiplier', s.spikeMultiplier, 2.0, '\u00d7');
    setRange('s-hysteresisCount', 'v-hysteresisCount', s.hysteresisCount, 3,   '');
    setRange('s-errorMarginPercent', 'v-errorMarginPercent', s.errorMarginPercent, 0, '%');
    setNum('s-missingPowerTimeoutS', s.missingPowerTimeoutS, 120);
    var drgEl = document.getElementById('s-dynamicRestoreGuard');
    if (drgEl) drgEl.checked = (s.dynamicRestoreGuard !== false);
    if (s.classFilters && typeof s.classFilters === 'object') {
      _classFilters = s.classFilters;
    }
    priorityList = Array.isArray(s.priorityList) ? s.priorityList : [];
    updatePhaseConfigVisibility();
  }
  function setNum(id, val, fb) {
    var e = document.getElementById(id);
    if (e) e.value = (val != null) ? val : fb;
  }
  function setRange(id, vid, val, fb, sfx) {
    var e = document.getElementById(id), v = document.getElementById(vid), n = (val != null) ? val : fb;
    if (e) e.value = n;
    if (v) v.textContent = n + sfx;
  }

  // ── System configuration ────────────────────────────────────────────────────
  function updatePhaseConfigVisibility() {
    renderAllDevices();  // Refresh device list to update power calculations
    renderChargerDetails();  // Update charger power details based on voltage system
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 4 — HAN / POWER METER                                ██
  // ══════════════════════════════════════════════════════════════════
  //  a. loadMeterDevices()    — populate meter device dropdown
  //  b. changeMeterDevice()   — switch active HAN meter
  //  c. updateMeterStatus()   — live meter connection badge
  //  d. loadHanDiagnostic()   — full HAN diagnostic JSON panel
  //  e. copyHanDiagnostic()   — copy diagnostic to clipboard
  //
  //  ✅ STABLE — shown in System tab, HAN Meter Diagnostics card
  // ══════════════════════════════════════════════════════════════════

  // ── Meter device selector ──────────────────────────────────────────────────
  function loadMeterDevices() {
    hApi('GET', '/meter-devices', null)
      .then(function(devices) {
        var sel = document.getElementById('s-meterDevice');
        if (!sel) return;
        // Keep auto option, clear rest
        var currentVal = sel.value;
        sel.innerHTML = '<option value=\"auto\">Auto-detect</option>';
        if (Array.isArray(devices)) {
          devices.forEach(function(d) {
            var opt = document.createElement('option');
            opt.value = d.id;
            var label = d.name;
            if (d.class && d.class !== 'other') label += ' (' + d.class + ')';
            opt.textContent = label;
            sel.appendChild(opt);
          });
        }
        // Restore saved selection
        var savedId = _savedMeterDeviceId || 'auto';
        sel.value = savedId;
        // If the saved device is not in the list, fall back to auto
        if (sel.value !== savedId) sel.value = 'auto';
        updateMeterStatus();
        dbg('Loaded ' + (devices ? devices.length : 0) + ' meter devices');
      })
      .catch(function(err) {
        dbg('Meter device load error: ' + (err.message || err));
      });
  }

  var _savedMeterDeviceId = 'auto';

  function changeMeterDevice(deviceId) {
    var statusEl = document.getElementById('meter-status');
    if (statusEl) statusEl.innerHTML = '<span style=\"color:#ff9500\">⏳ Switching meter...</span>';
    hApi('POST', '/set-meter-device', { deviceId: deviceId })
      .then(function(result) {
        _savedMeterDeviceId = deviceId;
        if (result && result.hanConnected) {
          if (statusEl) statusEl.innerHTML = '<span style=\"color:#34c759\">✓ Connected to ' + escHtml(result.hanDeviceName || 'meter') + '</span>';
        } else {
          if (statusEl) statusEl.innerHTML = '<span style=\"color:#ff3b30\">✗ No meter found' + (deviceId === 'auto' ? ' (auto-detect)' : '') + '</span>';
        }
        dbg('Meter device changed to: ' + deviceId + ', connected: ' + (result && result.hanConnected));
      })
      .catch(function(err) {
        if (statusEl) statusEl.innerHTML = '<span style=\"color:#ff3b30\">✗ Error: ' + escHtml(err.message || err) + '</span>';
        dbg('Meter device change error: ' + (err.message || err));
      });
  }

  function updateMeterStatus() {
    var statusEl = document.getElementById('meter-status');
    if (!statusEl) return;
    hApi('GET', '/cache-status', null)
      .then(function(result) {
        if (result && result.hanConnected) {
          statusEl.innerHTML = '<span style=\"color:#34c759\">✓ Meter connected</span>';
        } else {
          statusEl.innerHTML = '<span style=\"color:#ff9500\">⚠ No meter connected</span>';
        }
      })
      .catch(function() {});
  }

  function loadHanDiagnostic() {
    var el = document.getElementById('han-diag-content');
    if (!el) return;
    hApi('GET', '/han-diagnostic', null)
      .then(function(d) {
        if (!d) { el.innerHTML = '<span style="color:var(--text-muted)">No data</span>'; return; }
        var connColor = d.hanConnected ? '#34c759' : '#ff3b30';
        var connText = d.hanConnected ? 'Connected' : 'Not connected';
        var ageColor = '#636366';
        var ageText = '-';
        if (d.lastReadingAgeSeconds != null) {
          var a = d.lastReadingAgeSeconds;
          ageText = a < 5 ? 'Live' : a < 60 ? a + 's ago' : Math.round(a / 60) + 'm ago';
          ageColor = a < 10 ? '#34c759' : a < 30 ? '#ff9500' : '#ff3b30';
        }
        var src = d.readingSource || 'none';
        var srcLabel = src === 'event' ? 'Events' : src === 'poll' ? 'Polling only' : src === 'event+poll' ? 'Events + Polling' : 'None';
        var srcColor = src === 'none' ? '#ff3b30' : src === 'poll' ? '#ff9500' : '#34c759';

        var html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; margin-bottom:10px;">';
        html += '<div><strong>Status:</strong> <span style="color:' + connColor + '">' + connText + '</span></div>';
        html += '<div><strong>Last reading:</strong> <span style="color:' + ageColor + '">' + ageText + '</span></div>';
        html += '<div><strong>Device:</strong> ' + escHtml(d.hanDeviceName || '-') + '</div>';
        html += '<div><strong>Brand:</strong> ' + escHtml(d.hanBrand || '-') + '</div>';
        html += '<div><strong>Source:</strong> <span style="color:' + srcColor + '">' + srcLabel + '</span></div>';
        html += '<div><strong>Mode:</strong> ' + escHtml(d.selectionMode || '-') + '</div>';
        html += '<div><strong>Events:</strong> ' + (d.eventCount || 0) + '</div>';
        html += '<div><strong>Polls:</strong> ' + (d.pollCount || 0) + '</div>';
        html += '<div><strong>Spikes filtered:</strong> ' + (d.spikeFilterCount || 0) + '</div>';
        html += '<div><strong>Reconnects:</strong> ' + (d.watchdogReconnects || 0) + '</div>';
        html += '</div>';

        // Capabilities
        if (d.capabilities && d.capabilities.length > 0) {
          html += '<div style="margin-bottom:8px;"><strong>Capabilities:</strong> <span style="color:var(--text-muted); word-break:break-all;">' + escHtml(d.capabilities.join(', ')) + '</span></div>';
        }

        // Recent raw readings
        var log = d.rawLog || [];
        if (log.length > 0) {
          html += '<div style="margin-top:6px;"><strong>Recent readings:</strong></div>';
          html += '<div style="max-height:160px; overflow-y:auto; background:var(--bg-surface); border-radius:6px; padding:6px; margin-top:4px; font-family:monospace; font-size:11px;">';
          for (var i = log.length - 1; i >= 0; i--) {
            var entry = log[i];
            var t = entry.time ? entry.time.substring(11, 19) : '?';
            var srcBadge = entry.source === 'event' ? '<span style="color:#34c759">evt</span>'
                         : entry.source === 'poll' ? '<span style="color:#ff9500">poll</span>'
                         : entry.source === 'spike-filtered' ? '<span style="color:#ff3b30">spike</span>'
                         : '<span style="color:#007aff">' + escHtml(entry.source) + '</span>';
            html += '<div>' + t + '  ' + String(entry.value).padStart(7) + ' W  ' + srcBadge + '</div>';
          }
          html += '</div>';
        }

        // Power buffer
        var buf = d.powerBuffer || [];
        if (buf.length > 0) {
          html += '<div style="margin-top:6px;"><strong>Power buffer (last ' + buf.length + '):</strong> <span style="color:var(--text-muted)">' + buf.map(function(v) { return Math.round(v); }).join(', ') + ' W</span></div>';
        }

        el.innerHTML = html;
      })
      .catch(function(err) {
        el.innerHTML = '<span style="color:#ff3b30">Error: ' + escHtml(err.message || String(err)) + '</span>';
      });
  }

  function copyHanDiagnostic() {
    var msgEl = document.getElementById('han-diag-copy-msg');
    hApi('GET', '/han-diagnostic', null)
      .then(function(d) {
        var text = JSON.stringify(d, null, 2);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(function() {
            if (msgEl) { msgEl.style.display = 'block'; msgEl.innerHTML = '<span style="color:#34c759">Copied to clipboard</span>'; }
            setTimeout(function() { if (msgEl) msgEl.style.display = 'none'; }, 3000);
          });
        } else {
          // Fallback: select text in a textarea
          var ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          if (msgEl) { msgEl.style.display = 'block'; msgEl.innerHTML = '<span style="color:#34c759">Copied to clipboard</span>'; }
          setTimeout(function() { if (msgEl) msgEl.style.display = 'none'; }, 3000);
        }
      })
      .catch(function(err) {
        if (msgEl) { msgEl.style.display = 'block'; msgEl.innerHTML = '<span style="color:#ff3b30">Error: ' + escHtml(err.message || String(err)) + '</span>'; }
      });
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 5 — EV CHARGERS                                      ██
  // ══════════════════════════════════════════════════════════════════
  //  a. renderChargerDetails()          — charger table in System tab
  //                                       (Max Current, phases, power)
  //  b. updateChargerCircuitFromSystem() — inline edit Max Current field
  //  c. syncChargerLimitsFromDevices()  — read Ladergrense (ID47) from
  //                                       live device / pre-mitigation
  //                                       snapshot
  //  d. updateChargerPhases()           — 1-phase / 3-phase selector
  //  e. testChargerControl()            — send a test current command
  //  f. showDiagnostics()               — full charger diagnostics panel
  //  g. getVoltageConverter()           — A → W converter helper
  //  h. getMaxAmpFromWatt()             — W → A helper
  //
  //  ⚡ ACTIVE — ID47 = permanent Ladergrense, ID48 = Midlertidig
  //             PowerGuard throttles via ID48 (volatile) to avoid
  //             wearing FLASH. ID47 is read-only for Max Current display.
  // ══════════════════════════════════════════════════════════════════

  /**
   * Render charger-specific power details based on voltage system.
   */
  function renderChargerDetails() {
    var container = document.getElementById('charger-details-list');
    if (!container) return;

    // Use the already-loaded priorityList variable (no extra API call needed)
    var chargers = (priorityList || []).filter(function(e) { 
      return (e.action === 'dynamic_current' || e.action === 'charge_pause') && e.enabled !== false; 
    });

    if (chargers.length === 0) {
      container.innerHTML = '<span style="color:var(--text-muted)">No chargers configured</span>';
      return;
    }

    var voltageSystem = _resolveVoltageSystem();
    var mainCircuitA = parseInt(document.getElementById('s-mainCircuitA').value) || 25;
    var voltageLabel = voltageSystem === '400v-3phase' ? '400V' : '230V';
    var voltageMultiplier = voltageSystem === '400v-3phase' ? 692 : 230;

    var html = '<table style="width:100%; border-collapse:collapse;">';
    html += '<thead><tr style="border-bottom:2px solid var(--border-color);">' +
            '<th style="text-align:left; padding:8px 4px;">Charger</th>' +
            '<th style="text-align:center; padding:8px 4px;">Status</th>' +
            '<th style="text-align:center; padding:8px 4px;">Phases</th>' +
            '<th style="text-align:center; padding:8px 4px;">Max Current</th>' +
            '<th style="text-align:center; padding:8px 4px;">Max Power</th>' +
            '</tr></thead><tbody>';

    var totalCircuitA = 0;
    var totalPowerW = 0;

    chargers.forEach(function(charger, idx) {
      var circuitA = charger.circuitLimitA || 32;
      var chargerPhases = charger.chargerPhases || 3;
      var effectiveA = Math.min(circuitA, mainCircuitA);
      // Per-charger voltage: 1-phase = 230V, 3-phase = 692V (√3 × 400)
      var perChargerVoltage = chargerPhases === 1 ? 230 : 692;
      var maxPowerW = Math.round(perChargerVoltage * effectiveA);

      totalCircuitA += circuitA;
      totalPowerW += maxPowerW;

      // Get live status from last status update
      var liveStatus = _lastChargerStatus[charger.deviceId] || { status: 'idle', statusLabel: 'Idle' };
      var statusColor = liveStatus.status === 'paused' ? '#ff3b30' :
                        liveStatus.status === 'dynamic' ? '#ff9500' :
                        liveStatus.status === 'charging' ? '#34c759' :
                        liveStatus.status === 'waiting' ? '#007aff' :
                        liveStatus.status === 'completed' ? '#34c759' :
                        liveStatus.status === 'connected' ? 'var(--text-muted)' :
                        '#8e8e93';
      var statusIcon = liveStatus.status === 'paused' ? '⏸' :
                       liveStatus.status === 'dynamic' ? '⚡' :
                       liveStatus.status === 'charging' ? '🔋' :
                       liveStatus.status === 'waiting' ? '⏳' :
                       liveStatus.status === 'completed' ? '✅' :
                       liveStatus.status === 'connected' ? '🔌' :
                       '➖';

      var bgColor = idx % 2 === 0 ? 'transparent' : 'var(--bg-surface)';
      html += '<tr style="background:' + bgColor + '; border-bottom:1px solid var(--border-color);">' +
              '<td style="padding:8px 4px;">' + escHtml(charger.name) + '</td>' +
              '<td style="text-align:center; padding:8px 4px;">' +
              '<span id="charger-status-' + charger.deviceId + '" style="font-size:11px; font-weight:600; color:' + statusColor + '; white-space:nowrap;">' +
              statusIcon + ' ' + escHtml(liveStatus.statusLabel) + '</span></td>' +
              '<td style="text-align:center; padding:8px 4px;">' +
              '<select onchange="updateChargerPhases(\'' + charger.deviceId + '\',this.value)" ' +
              'style="font-size:12px; border:1px solid var(--border-color); border-radius:4px; padding:2px 4px;">' +
              '<option value="1"' + (chargerPhases === 1 ? ' selected' : '') + '>1-phase</option>' +
              '<option value="3"' + (chargerPhases === 3 ? ' selected' : '') + '>3-phase</option>' +
              '</select>' +
              '</td>' +
              '<td style="text-align:center; padding:8px 4px;">' +
              '<input type="number" min="6" max="32" value="' + circuitA + '" ' +
              'onchange="updateChargerCircuitFromSystem(\'' + charger.deviceId + '\',this.value)" ' +
              'style="width:50px; font-size:12px; text-align:center; border:1px solid var(--border-color); border-radius:4px; padding:2px 4px;">' +
              '<span style="font-size:11px; color:var(--text-muted);"> A</span>' +
              '</td>' +
              '<td style="text-align:center; padding:8px 4px;">' + (maxPowerW / 1000).toFixed(1) + ' kW</td>' +
              '</tr>';
    });

    // Total summary row
    html += '<tr style="border-top:2px solid var(--border-color); font-weight:bold;">' +
            '<td style="padding:8px 4px;">Total (' + chargers.length + ' charger' + (chargers.length > 1 ? 's' : '') + ')</td>' +
            '<td></td>' +
            '<td></td>' +
            '<td style="text-align:center; padding:8px 4px;">' + totalCircuitA + ' A</td>' +
            '<td style="text-align:center; padding:8px 4px;">' + (totalPowerW / 1000).toFixed(1) + ' kW</td>' +
            '</tr>';

    html += '</tbody></table>';
    html += '<div style="font-size:11px; color:var(--text-muted); margin-top:8px; line-height:1.5;">' +
            '💡 <b>Max Current</b> = Easee Ladergrense (permanent charger limit). ' +
            'Capped by circuit breaker (' + mainCircuitA + 'A). Actual current is reduced further during overload mitigation.' +
            '</div>';

    // Debug: show raw charger_status values from the Easee API
    html += '<div style="margin-top:12px; padding:8px; background:var(--bg-surface); border-radius:6px; font-size:11px; font-family:monospace; color:var(--text-muted); line-height:1.6;">';
    html += '<div style="font-weight:600; margin-bottom:4px;">🔍 Raw charger status (debug)</div>';
    chargers.forEach(function(charger) {
      var live = _lastChargerStatus[charger.deviceId] || {};
      var lim  = _lastChargerLimits[charger.deviceId];
      html += '<div>' + escHtml(charger.name) + ': ' +
              'charger_status=' + (live.chargerStatus !== undefined && live.chargerStatus !== null ? live.chargerStatus : 'N/A') +
              ' | status=' + (live.status || '?') +
              ' | label=' + (live.statusLabel || '?') +
              ' | power=' + (live.powerW || 0) + 'W' +
              ' | offered=' + (live.offeredCurrent != null ? live.offeredCurrent + 'A' : 'N/A') +
              ' | <b>ID47 Ladergrense=' + (lim && lim.maxCurrent != null ? lim.maxCurrent + 'A' : 'N/A') + (lim && lim.mitigated ? ' ⚡snapshot' : '') + '</b>' +
              (lim && lim.dynamic_charger_current != null ? ' | ID48 Midlertidig=' + lim.dynamic_charger_current + 'A' : '') +
              (lim && lim.circuit_current         != null ? ' | circuit='          + lim.circuit_current         + 'A' : '') +
              (lim && lim.allValues && Object.keys(lim.allValues).length ? ' | <i>caps: ' + Object.entries(lim.allValues).map(function(kv){return kv[0]+'='+kv[1];}).join(', ') + '</i>' : '') +
              ' | confirmed=' + (live.confirmed ? '\u2713' : '\u2717') +
              ' | reliability=' + (live.reliability != null ? live.reliability + '%' : '?') +
              ' | isCharging=' + (live.isCharging !== undefined ? live.isCharging : '?') +
              '</div>';
    });
    html += '</div>';

    container.innerHTML = html;
  }

  /**
   * Update a charger's circuit limit from the System tab, then refresh both views.
   */
  function updateChargerCircuitFromSystem(deviceId, val) {
    var ampVal = parseInt(val) || 32;
    if (ampVal < 6) ampVal = 6;
    if (ampVal > 32) ampVal = 32;
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) {
      entry.circuitLimitA = ampVal;
      savePriorityList();
      renderChargerDetails();
      renderAllDevices();
      hApi('POST', '/apply-circuit-limits', {})
        .then(function(data) { dbg('Circuit limits pushed: ' + JSON.stringify(data)); })
        .catch(function(err) { dbg('Circuit limit push error: ' + (err.message || err)); });
    }
  }

  /**
   * Read live target_charger_current from each configured charger device and
   * update the in-memory priorityList + re-render so the UI shows the real value.
   * Called automatically on page load and by the "Read from charger" button.
   */
  function syncChargerLimitsFromDevices(silent) {
    var msgEl = document.getElementById('charger-sync-msg');
    if (!silent && msgEl) { msgEl.style.display = 'block'; msgEl.textContent = '⏳ Reading from charger…'; }
    hApi('GET', '/get-charger-limits', null)
      .then(function(limits) {
        if (!limits) return;
        var updated = [];
        priorityList.forEach(function(entry) {
          var live = limits[entry.deviceId];
          if (!live) return;
          // target_charger_current = ID47 (permanent Ladergrense). Server returns pre-mitigation value when throttled.
          // target_charger_current (Homey) = ID47 maxChargerCurrent = permanent Ladergrense
          // Server returns the pre-mitigation snapshot when the charger is actively throttled,
          // so this value is always the user-configured permanent max (e.g. 14A), not the
          // current throttled value (e.g. 7A).
          var maxCurrent = (live.target_charger_current != null && live.target_charger_current > 0) ? Math.round(live.target_charger_current) : null;
          var liveA = maxCurrent;  // Max Current = Ladergrense (ID47), derived from snapshot when throttled
          // Store raw values for the debug display in renderChargerDetails
          _lastChargerLimits[entry.deviceId] = {
            maxCurrent:              maxCurrent,    // ID47  permanent Ladergrense (pre-mitigation snapshot when throttled)
            mitigated:               !!live.mitigated,
            dynamic_charger_current: live.dynamic_charger_current != null ? Math.round(live.dynamic_charger_current) : null,  // ID48 volatile
            circuit_current:         (live.target_circuit_current != null && live.target_circuit_current > 0) ? Math.round(live.target_circuit_current) : null,
            allValues:               live.allValues || {},
          };
          // Never overwrite circuitLimitA while Power Guard is actively throttling the charger
          if (liveA != null && entry.circuitLimitA !== liveA && !live.mitigated) {
            updated.push(entry.name + ': ' + (entry.circuitLimitA || 32) + 'A → ' + liveA + 'A');
            entry.circuitLimitA = liveA;
          } else if (!silent && liveA != null) {
            dbg(entry.name + ': Max Current (ID47)=' + liveA + 'A' + (live.mitigated ? ' (pre-mitigation snapshot)' : ' (live)') + ' — already set');
          }
        });
        if (updated.length) {
          renderChargerDetails();
          savePriorityList();  // Persist the updated circuitLimitA values
          if (msgEl) { msgEl.style.display = 'block'; msgEl.textContent = '✅ Synced: ' + updated.join(', '); }
          dbg('Charger limits synced from devices: ' + updated.join(', '));
        } else {
          renderChargerDetails();  // Still refresh to show ID47/ID48 values in debug row
          if (!silent && msgEl) {
            // Build a summary of what the charger actually reported
            var summary = [];
            priorityList.forEach(function(e) {
              var lim = _lastChargerLimits[e.deviceId];
              if (lim) summary.push(e.name + ': ID47=' + (lim.maxCurrent != null ? lim.maxCurrent + 'A' : 'N/A') +
                (lim.mitigated ? ' (snapshot)' : ' (live)'));
            });
            msgEl.style.display = 'block';
            msgEl.textContent = '✅ Already in sync. ' + summary.join(' | ');
          }
        }
        if (msgEl) setTimeout(function() { msgEl.style.display = 'none'; }, 6000);
      })
      .catch(function(err) {
        dbg('getChargerLimits error: ' + (err.message || err));
        if (!silent && msgEl) { msgEl.style.display = 'block'; msgEl.textContent = '⚠ Could not read from charger: ' + (err.message || err); }
      });
  }

  function updateChargerPhases(deviceId, val) {
    var phases = parseInt(val) || 3;
    if (phases !== 1) phases = 3;
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) {
      entry.chargerPhases = phases;
      savePriorityList();
      renderChargerDetails();
      renderAllDevices();
    }
  }

  function testChargerControl() {
    var resultDiv = document.getElementById('charger-test-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<span style="color:var(--text-muted)">⏳ Testing charger control...</span>';

    hApi('POST', '/test-charger', {})
      .then(function(data) {
        if (!data || !data.steps) {
          resultDiv.innerHTML = '<span style="color:#ff3b30">⚠ No response from test</span>';
          return;
        }
        var html = '';
        data.steps.forEach(function(step) {
          var icon = step.ok ? '✅' : '❌';
          html += '<div style="padding:3px 0; border-bottom:1px solid var(--border-color);">' +
                  icon + ' <strong>' + step.step + '</strong>: ' +
                  '<span style="color:' + (step.ok ? '#34c759' : '#ff3b30') + ';">' + step.detail + '</span>' +
                  '</div>';
        });
        if (data.success) {
          html += '<div style="padding:6px 0; color:#34c759; font-weight:600;">✅ Charger control is working!</div>';
        } else {
          html += '<div style="padding:6px 0; color:#ff3b30; font-weight:600;">❌ Charger control failed — see details above</div>';
        }
        resultDiv.innerHTML = html;
      })
      .catch(function(err) {
        resultDiv.innerHTML = '<span style="color:#ff3b30">⚠ Test failed: ' + (err.message || err) + '</span>';
      });
  }

  function showDiagnostics() {
    var resultDiv = document.getElementById('charger-test-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<span style="color:var(--text-muted)">⏳ Loading diagnostics...</span>';

    hApi('GET', '/diagnostic', null)
      .then(function(data) {
        if (!data) {
          resultDiv.innerHTML = '<span style="color:#ff3b30">⚠ No data</span>';
          return;
        }
        var html = '<div style="padding:4px 0; font-weight:600; border-bottom:2px solid var(--border-color);">Power Guard Diagnostics</div>';
        html += '<div style="padding:3px 0;">⚡ <strong>Power:</strong> ' + (data.currentPowerW || 0) + 'W / ' + (data.limitW || 0) + 'W limit</div>';
        html += '<div style="padding:3px 0;">📊 <strong>Over-limit count:</strong> ' + (data.overLimitCount || 0) + ' / ' + (data.hysteresisCount || 0) + ' needed</div>';
        html += '<div style="padding:3px 0;">🔌 <strong>HAN connected:</strong> ' + (data.hanConnected ? '✅ Yes' : '❌ No') + '</div>';
        html += '<div style="padding:3px 0;">📡 <strong>Last HAN reading:</strong> ' + (data.lastHanReading || 'never') + '</div>';
        html += '<div style="padding:3px 0;">📦 <strong>Power buffer:</strong> ' + (data.powerBufferLen || 0) + ' readings</div>';
        html += '<div style="padding:3px 0;">🛡️ <strong>Guard enabled:</strong> ' + (data.enabled ? '✅ Yes' : '❌ No') + '</div>';
        html += '<div style="padding:3px 0;">⏱️ <strong>Cooldown:</strong> ' + (data.cooldownSeconds || 0) + 's</div>';
        html += '<div style="padding:3px 0;">🕐 <strong>Last mitigation:</strong> ' + (data.lastMitigationTime || 'never') + '</div>';

        var md = data.mitigatedDevices || [];
        html += '<div style="padding:3px 0;">📋 <strong>Devices controlled:</strong> ' + md.length + '</div>';
        md.forEach(function(m) {
          html += '<div style="padding:2px 0 2px 16px; color:#ff9500;">→ ' + m.deviceId.substring(0, 8) + '... action=' + m.action + (m.currentTargetA != null ? ' @ ' + m.currentTargetA + 'A' : '') + '</div>';
        });

        var chargers = data.easeeChargers || [];
        html += '<div style="padding:3px 0; margin-top:4px;"><strong>Configured chargers:</strong> ' + chargers.length + '</div>';
        chargers.forEach(function(c) {
          html += '<div style="padding:2px 0 2px 16px;">🔋 ' + c.name + ' (limit=' + (c.circuitLimitA || '?') + 'A, enabled=' + c.enabled + ')</div>';
        });

        var logs = data.recentLog || [];
        if (logs.length) {
          html += '<div style="padding:3px 0; margin-top:4px;"><strong>Recent log:</strong></div>';
          logs.forEach(function(l) {
            html += '<div style="padding:1px 0 1px 16px; font-size:11px; color:var(--text-muted);">' + l + '</div>';
          });
        }

        resultDiv.innerHTML = html;
      })
      .catch(function(err) {
        resultDiv.innerHTML = '<span style="color:#ff3b30">⚠ Diagnostics failed: ' + (err.message || err) + '</span>';
      });
  }

  // Returns the active voltageSystem string, resolving 'auto' via server detection
  function _resolveVoltageSystem() {
    var selected = document.getElementById('s-voltageSystem').value;
    return (selected === 'auto') ? _detectedVoltageSystem : selected;
  }

  // Shows a badge describing what was detected (or nothing when manually overridden)
  function _updateVoltageDetectedBadge() {
    var badge = document.getElementById('voltage-detected-badge');
    if (!badge) return;
    var selected = document.getElementById('s-voltageSystem').value;
    if (selected === 'auto') {
      var label = _detectedVoltageSystem === '400v-3phase' ? '3-phase (400V)' : '1-phase (230V)';
      badge.textContent = 'ℹ️ Auto-detected: ' + label;
      badge.style.color = 'var(--color-success, #34c759)';
    } else {
      badge.textContent = '';
    }
  }

  function getVoltageConverter() {
    var voltageSystem = _resolveVoltageSystem();
    // Returns a function that converts amperage to watts
    if (voltageSystem === '400v-3phase') {
      // 400V 3-phase: P = √3 × 400V × A = 692 × A (per phase)
      return function(ampA) { return Math.round(692 * ampA); };
    } else {
      // 230V single-phase: P = 230V × A
      return function(ampA) { return Math.round(230 * ampA); };
    }
  }

  function getMaxAmpFromWatt(wattW) {
    var voltageSystem = _resolveVoltageSystem();
    if (voltageSystem === '400v-3phase') {
      return Math.round(wattW / 692);
    } else {
      return Math.round(wattW / 230);
    }
  }

  // ── Load all data ──────────────────────────────────────────────────────────
  function loadAll() {
    clearError();
    dbg('Loading all data via Homey.api...');
    hApi('GET', '/all', null)
      .then(function(data) {
        var settings = data.settings || {};
        var status = data.status || {};
        var devices = data.devices || [];
        var defs = {
          enabled: true, profile: 'normal', powerLimitW: 10000,
          phase1LimitA: 0, phase2LimitA: 0, phase3LimitA: 0,
          smoothingWindow: 5, spikeMultiplier: 2.0,
          hysteresisCount: 3, cooldownSeconds: 30, priorityList: []
        };
        Object.keys(defs).forEach(function(k) {
          if (settings[k] == null) settings[k] = defs[k];
        });
        dbg('Settings loaded: ' + JSON.stringify(settings).substring(0, 200));
        _detectedVoltageSystem = data.detectedVoltageSystem || '230v-1phase';
        applySettings(settings);
        updateStatusUI(status);
        availableDevices = Array.isArray(devices) ? devices : [];
        _savedMeterDeviceId = settings.selectedMeterDeviceId || 'auto';
        renderAllDevices();
        renderChargerDetails();  // Refresh charger details after loading
        syncChargerLimitsFromDevices(true);  // Auto-sync live values from charger devices (silent)
        loadMeterDevices();  // Load meter device dropdown
        loadHanDiagnostic();  // Load HAN diagnostic info
        dbg('Load complete: ' + availableDevices.length + ' devices');
      })
      .catch(function(err) {
        dbg('Load error: ' + (err.message || err));
        showError('Cannot load settings: ' + (err.message || err));
        renderAllDevices();
      });
  }

  // ── Collect settings from form ─────────────────────────────────────────────
  function collectSettings() {
    var getNumValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      var val = parseInt(el.value, 10);
      return isNaN(val) ? fb : val;
    };
    var getFloatValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      var val = parseFloat(el.value);
      return isNaN(val) ? fb : val;
    };
    var getBoolValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      return el.checked !== undefined ? el.checked : fb;
    };
    var getStringValue = function(id, fb) {
      var el = document.getElementById(id);
      if (!el) return fb;
      return el.value || fb;
    };
    return {
      enabled:         getBoolValue('s-enabled', true),
      profile:         getStringValue('s-profile', 'normal'),
      powerLimitW:     getNumValue('s-powerLimitW', 10000),
      phase1LimitA:    getNumValue('s-phase1LimitA', 0),
      phase2LimitA:    getNumValue('s-phase2LimitA', 0),
      phase3LimitA:    getNumValue('s-phase3LimitA', 0),
      smoothingWindow: getNumValue('s-smoothingWindow', 5),
      spikeMultiplier: getFloatValue('s-spikeMultiplier', 2.0),
      hysteresisCount: getNumValue('s-hysteresisCount', 3),
      cooldownSeconds: getNumValue('s-cooldownSeconds', 30),
      errorMarginPercent: getNumValue('s-errorMarginPercent', 0),
      missingPowerTimeoutS: getNumValue('s-missingPowerTimeoutS', 120),
      dynamicRestoreGuard: (function(){ var e=document.getElementById('s-dynamicRestoreGuard'); return e ? e.checked : true; })(),
      voltageSystem:   getStringValue('s-voltageSystem', 'auto'),
      phaseDistribution: getStringValue('s-phaseDistribution', 'balanced'),
      mainCircuitA:    getNumValue('s-mainCircuitA', 25),
      classFilters:    _classFilters,
      priorityList:    priorityList
    };
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 6 — POWER CONSUMPTION                                ██
  // ══════════════════════════════════════════════════════════════════
  //  a. renumberVisibleDevices() — re-index filtered device list
  //  b. toggleClassFilter()      — device class filter chips (light,
  //                                socket, etc.)
  //  c. loadConsumption()        — fetch + render Power tab devices
  //
  //  🔵 ACTIVE — Power tab
  // ══════════════════════════════════════════════════════════════════

  // ── Load Power Consumption ─────────────────────────────────────────────────
  var _consumptionRefresh = null;
  var _classFilters = {}; // Track which device classes are visible
  
  function renumberVisibleDevices() {
    // Renumber visible rows only
    var rows = document.querySelectorAll('.consumption-row:not([style*="display: none"])');
    var visibleCount = 0;
    document.querySelectorAll('.consumption-row').forEach(function(row) {
      if (row.style.display !== 'none') {
        visibleCount++;
        var firstCell = row.querySelector('td');
        if (firstCell) {
          // Extract device name (everything after ". " in the current text)
          var currentText = firstCell.textContent;
          var deviceName = currentText.substring(currentText.indexOf('. ') + 2);
          firstCell.textContent = visibleCount + '. ' + deviceName;
        }
      }
    });
  }
  
  function toggleClassFilter(className) {
    // Get the checkbox element first
    var checkbox = document.querySelector('[data-class-filter="' + className + '"]');
    if (!checkbox) return;
    
    // Use the checkbox's actual checked state (already changed by browser)
    _classFilters[className] = checkbox.checked;
    
    // Update visibility of all rows
    var rows = document.querySelectorAll('.consumption-row');
    rows.forEach(function(row) {
      var rowClass = row.getAttribute('data-device-class');
      var isVisible = _classFilters[rowClass] !== false;
      row.style.display = isVisible ? '' : 'none';
    });
    
    // Renumber visible devices
    renumberVisibleDevices();
    
    // Save immediately
    saveAll();
  }
  
  function loadConsumption() {
    if (!_H) { showError('Not connected to Homey'); return; }
    hApi('GET', '/powerConsumption', null)
      .then(function(data) {
        clearError();
        var devices = data.devices || [];
        var totalW = data.totalW || 0;
        var tbody = document.getElementById('consumption-table');
        if (!tbody)  return;

        if (devices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text-tertiary);">No devices with power data found</td></tr>';
          document.getElementById('consumption-time').textContent = '–';
          document.getElementById('device-type-filters').innerHTML = '';
          return;
        }

        // Collect unique device classes
        var classesSet = {};
        devices.forEach(function(d) {
          var cls = d.class || 'unknown';
          classesSet[cls] = true;
        });
        var classes = Object.keys(classesSet).sort();

        // Create filter checkboxes
        var filterHtml = classes.map(function(cls) {
          var isChecked = _classFilters[cls] !== false;
          return '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;">' +
            '<input type="checkbox" data-class-filter="' + cls + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleClassFilter(\'' + cls + '\')" style="cursor:pointer;accent-color:#e8441a;">' +
            '<span style="font-size:13px;color:var(--text-primary);font-weight:500;">' + (cls.charAt(0).toUpperCase() + cls.slice(1)) + '</span>' +
            '</label>';
        }).join('');
        document.getElementById('device-type-filters').innerHTML = filterHtml;

        var rows = devices.map(function(d, idx) {
          var deviceName = (d.name || 'Unknown') + (d.class ? ' (' + d.class + ')' : '');
          var cls = d.class || 'unknown';
          var isVisible = _classFilters[cls] !== false;
          var display = isVisible ? '' : 'display:none;';
          return '<tr style="border-bottom:1px solid var(--border-light);' + display + '" class="consumption-row" data-device-class="' + cls + '">' +
            '<td style="padding:10px 0;color:var(--text-primary);">' + (idx + 1) + '. ' + deviceName + '</td>' +
            '<td style="text-align:right;padding:10px 0;color:var(--text-primary);font-weight:500;">' + d.current + ' W</td>' +
            '<td style="text-align:right;padding:10px 0;color:var(--text-muted);">' + d.avg + ' W</td>' +
            '<td style="text-align:right;padding:10px 0;color:var(--text-muted);">' + d.peak + ' W</td>' +
            '<td style="text-align:right;padding:10px 0;color:#ff6b35;font-weight:500;">' + d.percent + '%</td>' +
            '</tr>';
        }).join('');
        tbody.innerHTML = rows;

        var timeStr = new Date(data.timestamp).toLocaleTimeString('sv-SE');
        document.getElementById('consumption-time').textContent = timeStr;
        
        // Renumber visible devices based on current filters
        renumberVisibleDevices();
      })
      .catch(function(err) {
        showError('Failed to load power consumption: ' + err.message);
      });
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 7 — HEATERS (Floor / Thermostat)                     ██
  // ══════════════════════════════════════════════════════════════════
  //  a. loadFloorHeaters()  — fetch + render Heaters tab
  //  b. controlHeater()     — on / off / heat mode
  //  c. stepTemp()          — +/- temperature buttons
  //  d. setHeaterTemp()     — apply typed temperature value
  //
  //  🔵 ACTIVE — Heaters tab
  //  ⚠  Adax: uses target_temperature + thermostat_mode  
  //           (thermostat_mode must be set to 'heat' before setting temp)
  // ══════════════════════════════════════════════════════════════════

  // ── Load Floor Heater Connections ─────────────────────────────────────────
  var _heaterRefreshTimer = null;

  function loadFloorHeaters() {
    if (!_H) { showError('Not connected to Homey'); return; }
    hApi('GET', '/floorHeaters', null)
      .then(function(data) {
        clearError();
        var heaters = Array.isArray(data) ? data : [];
        var list = document.getElementById('floorheater-list');
        if (!list) return;

        var countEl = document.getElementById('floorheater-count');
        if (countEl) countEl.textContent = heaters.length;

        if (heaters.length === 0) {
          list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;">No thermostats found</div>';
          return;
        }

        list.innerHTML = heaters.map(function(h) {
          var isOn = !!h.isOn;
          // Show as "drawing" (orange highlight) if we have positive wattage,
          // OR if the device is on but has no power sensor (fall back to onoff state).
          var hasPowerData = h.currentPowerW != null;
          var drawing = hasPowerData ? Number(h.currentPowerW) > 0 : isOn;
          var cur = h.currentMeasure != null ? Number(h.currentMeasure).toFixed(1) + '°' : '–';
          var id  = h.deviceId;
          var tgtVal = h.currentTarget != null ? Number(h.currentTarget).toFixed(1) : '20.0';
          var chk = isOn ? ' checked' : '';
          var isDirty = _heaterDirty.hasOwnProperty(id);
          var displayVal = isDirty ? Number(_heaterDirty[id]).toFixed(1) : tgtVal;
          var modeLabel = '';
          if (h.thermostatMode) {
            var isHeat = h.thermostatMode === 'heat';
            modeLabel = '<span style="font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:' + (isHeat ? 'rgba(249,115,22,.15)' : 'rgba(0,0,0,.06)') + ';color:' + (isHeat ? 'var(--orange)' : 'var(--text-muted)') + ';letter-spacing:.03em;white-space:nowrap;">' + escHtml(h.thermostatMode) + '</span>';
          }
          var activeLabel = '';
          if (h.mitigated) {
            var stepText = h.mitigationStep === 2 ? 'OFF by PG' : '−3°C by PG';
            activeLabel = ' <span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:4px;background:rgba(249,115,22,.18);color:var(--orange);letter-spacing:.03em;white-space:nowrap;">&#9646; ' + stepText + '</span>';
          }
          // Show wattage if available, otherwise show "● ON" when device is on but has no power sensor
          var pwrLabel = (hasPowerData && Number(h.currentPowerW) > 5)
            ? ' <span style="font-size:10px;color:var(--orange);font-weight:600;">● ' + Math.round(h.currentPowerW) + 'W</span>'
            : (!hasPowerData && isOn ? ' <span style="font-size:10px;color:var(--orange);font-weight:600;">● ON</span>' : '');
          var arrow = h.hasTargetTemp ? ' → ' : '';

          return '<div class="heater-row' + (drawing ? ' is-on' : '') + '">' +
            '<span class="h-dot"></span>' +
            '<div class="h-info">' +
              '<div class="h-name">' + escHtml(h.name) + modeLabel + activeLabel + '</div>' +
              '<div class="h-cur">Now <b>' + cur + '</b>' + (h.hasTargetTemp ? arrow + tgtVal + '°' : '') + pwrLabel + '</div>' +
            '</div>' +
            '<div class="h-controls">' +
              (h.hasTargetTemp ? '<span class="h-stepper" data-id="' + id + '"><button class="h-step-btn" onclick="stepTemp(\'' + id + '\',-0.5)">&minus;</button><span class="h-temp-val' + (isDirty ? ' is-dirty' : '') + '" id="temp-' + id + '">' + displayVal + '</span><button class="h-step-btn" onclick="stepTemp(\'' + id + '\',0.5)">+</button></span><button class="h-set-btn" id="set-' + id + '" onclick="setHeaterTemp(\'' + id + '\')" title="Apply temperature">Set</button>' : '') +
              (h.hasOnOff ? '<label class="h-toggle"><input type="checkbox"' + chk + ' onchange="controlHeater(\'' + id + '\', this.checked?\'on\':\'off\')" /><span class="h-track"></span><span class="h-thumb"></span></label>' : '') +
            '</div>' +
          '</div>';
        }).join('');

        // Start auto-refresh while heater tab is visible
        if (!_heaterRefreshTimer) {
          _heaterRefreshTimer = setInterval(function() {
            var tab = document.getElementById('tab-floorheater');
            if (tab && tab.style.display !== 'none') {
              loadFloorHeaters();
            } else {
              clearInterval(_heaterRefreshTimer);
              _heaterRefreshTimer = null;
            }
          }, 2000);
        }
      })
      .catch(function(err) {
        showError('Failed to load heaters: ' + err.message);
        var list = document.getElementById('floorheater-list');
        if (list) list.innerHTML = '<div style="text-align:center;padding:20px;color:#ff3b30;font-size:12px;">Error loading thermostats</div>';
      });
  }

  function controlHeater(deviceId, action) {
    if (!_H) { showError('Not connected to Homey'); return; }
    hApi('POST', '/floorHeater-control', { deviceId: deviceId, action: action, value: null })
      .then(function(data) {
        if (data.ok) {
          showToast(data.message || 'Control sent');
          setTimeout(loadFloorHeaters, 500);
        } else {
          showError('Control failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(function(err) {
        showError('Control error: ' + err.message);
      });
  }

  function stepTemp(deviceId, delta) {
    var el = document.getElementById('temp-' + deviceId);
    if (!el) return;
    var cur = _heaterDirty.hasOwnProperty(deviceId) ? parseFloat(_heaterDirty[deviceId]) : parseFloat(el.textContent);
    var val = cur + delta;
    val = Math.round(val * 2) / 2;
    if (val < 5) val = 5;
    if (val > 35) val = 35;
    _heaterDirty[deviceId] = val;
    el.textContent = val.toFixed(1);
    el.classList.add('is-dirty');
  }

  function setHeaterTemp(deviceId) {
    if (!_H) { showError('Not connected to Homey'); return; }
    var tempEl = document.getElementById('temp-' + deviceId);
    if (!tempEl) return;
    var temp = parseFloat(_heaterDirty[deviceId] || tempEl.textContent);
    if (isNaN(temp)) { showError('Invalid temperature value'); return; }
    hApi('POST', '/floorHeater-control', { deviceId: deviceId, action: 'setTarget', value: temp })
      .then(function(data) {
        if (data.ok) {
          delete _heaterDirty[deviceId];
          showToast(data.message || 'Temperature set');
          setTimeout(loadFloorHeaters, 500);
        } else {
          showError('Failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(function(err) {
        showError('Error: ' + err.message);
      });
  }

  // Auto-load consumption when tab opened
  var _lastTabName = '';
  
  setInterval(function() {
    var consumptionTab = document.getElementById('tab-consumption');
    if (consumptionTab && consumptionTab.style.display === 'block') {
      loadConsumption();
    }
  }, 2000); // Update every 2 seconds

  // ── Save all settings ──────────────────────────────────────────────────────
  function saveAll() {
    clearError();
    if (!_H) { showError('Not connected to Homey'); return; }
    var settings = collectSettings();
    dbg('Saving settings...');
    Promise.all([
      hApi('POST', '/settings', settings),
      hApi('POST', '/priority-list', priorityList)
    ])
      .then(function() {
        dbg('All settings saved successfully');
        showToast();
        // After saving, push circuit limits to the physical chargers
        return hApi('POST', '/apply-circuit-limits', {});
      })
      .then(function(data) {
        if (data && data.results) {
          var ok = data.results.filter(function(r) { return r.ok; }).length;
          dbg('Circuit limits pushed: ' + ok + '/' + data.results.length + ' chargers');
        }
      })
      .catch(function(err) {
        dbg('Save error: ' + (err.message || err));
        showError('Save failed: ' + (err.message || err));
      });
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 8 — DEVICES TAB                                      ██
  // ══════════════════════════════════════════════════════════════════
  //  a. selOpt()                — <select> option helper
  //  b. renderAllDevices()      — full managed + unmanaged device list
  //  c. buildManagedRow()       — row for a managed priority-list device
  //  d. buildUnmanagedRow()     — row for an available-but-not-added device
  //  e. toggleDevice()          — add / remove from priority list
  //  f. updateDeviceAction()    — change action dropdown (dim, target_temp…)
  //  g. updateDeviceCircuitLimit() — inline circuit limit edit
  //  h. reorderManaged()        — drag-and-drop reorder
  //  i. updateEnabledSync() / syncEnabledCheckbox() — master enable toggle
  //  j. pressButton() / moveDevice() — keyboard reorder
  //  k. onTouchDragStart/Move/End — touch drag handlers
  //
  //  🔵 ACTIVE — Devices tab
  // ══════════════════════════════════════════════════════════════════

  // ── Devices tab rendering ──────────────────────────────────────────────────
  function selOpt(cur, val) { return cur === val ? ' selected' : ''; }

  function renderAllDevices() {
    var container = document.getElementById('devices-list');
    if (!container) return;
    container.innerHTML = '';
    var managed = priorityList.slice().sort(function(a, b) { return (a.priority || 0) - (b.priority || 0); });
    var managedIds = {};
    managed.forEach(function(e) { managedIds[e.deviceId] = true; });
    var unmanaged = availableDevices.filter(function(d) { return !managedIds[d.id]; });

    if (managed.length) {
      var lbl1 = document.createElement('div');
      lbl1.className = 'section-label';
      lbl1.textContent = 'Managed \u2014 turned off first to last';
      container.appendChild(lbl1);
      var ul = document.createElement('ul');
      ul.className = 'dev-list';
      ul.id = 'priority-list';
      managed.forEach(function(entry, idx) {
        ul.appendChild(buildManagedRow(entry, idx, managed.length));
      });
      container.appendChild(ul);
    }

    if (unmanaged.length) {
      var lbl2 = document.createElement('div');
      lbl2.className = 'section-label';
      lbl2.textContent = managed.length ? 'Not managed' : 'Available devices \u2014 toggle on to manage';
      container.appendChild(lbl2);
      var groups = {};
      unmanaged.forEach(function(dev) {
        var zone = dev.zoneName || 'Other';
        if (!groups[zone]) groups[zone] = [];
        groups[zone].push(dev);
      });
      var zoneNames = Object.keys(groups).sort(function(a, b) { return a.localeCompare(b); });
      var multiRoom = zoneNames.length > 1;
      zoneNames.forEach(function(zone) {
        if (multiRoom) {
          var roomLbl = document.createElement('div');
          roomLbl.className = 'room-label';
          roomLbl.textContent = zone;
          container.appendChild(roomLbl);
        }
        var ul = document.createElement('ul');
        ul.className = 'dev-list';
        groups[zone].forEach(function(dev) { ul.appendChild(buildUnmanagedRow(dev)); });
        container.appendChild(ul);
      });
    }

    if (!managed.length && !unmanaged.length) {
      var msg = document.createElement('p');
      msg.style.cssText = 'color:var(--text-tertiary);font-size:13px;padding:16px 0;text-align:center';
      msg.textContent = availableDevices.length
        ? 'Toggle devices on to manage them.'
        : 'No devices found. The cache is loading \u2014 this will update automatically.';
      container.appendChild(msg);
    }
  }

  function buildManagedRow(entry, idx, total) {
    var li = document.createElement('li');
    li.className = 'managed';
    var isControlled = !!_mitigatedDeviceIds[entry.deviceId];
    if (isControlled) {
      li.style.borderColor = '#ff9500';
      li.style.borderWidth = '2px';
      li.style.background = 'rgba(255, 149, 0, 0.08)';
    }
    li.innerHTML =
      '<span class="reorder-btns">' +
        '<button onclick="pressButton(this); moveDevice(' + idx + ',-1)"' + (idx === 0 ? ' disabled' : '') + ' title="Move up">' +
          '<svg width="13" height="13" viewBox="0 0 24 24"><defs><linearGradient id="gu' + idx + '" x1="0" y1="1" x2="0" y2="0"><stop offset="0%" stop-color="#1e40af"/><stop offset="40%" stop-color="#2563eb"/><stop offset="100%" stop-color="#60a5fa"/></linearGradient></defs><path d="M12 3L4 13h5v8h6v-8h5z" fill="url(#gu' + idx + ')" stroke="#1e3a8a" stroke-width="0.8" stroke-linejoin="round"/></svg>' +
        '</button>' +
        '<button onclick="pressButton(this); moveDevice(' + idx + ',1)"' + (idx === total - 1 ? ' disabled' : '') + ' title="Move down">' +
          '<svg width="13" height="13" viewBox="0 0 24 24"><defs><linearGradient id="gd' + idx + '" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#60a5fa"/><stop offset="60%" stop-color="#2563eb"/><stop offset="100%" stop-color="#1e40af"/></linearGradient></defs><path d="M12 21L4 11h5V3h6v8h5z" fill="url(#gd' + idx + ')" stroke="#1e3a8a" stroke-width="0.8" stroke-linejoin="round"/></svg>' +
        '</button>' +
      '</span>' +
      '<span class="priority-num">' + (idx + 1) + '.</span>' +
      '<span class="dev-name" style="' + (isControlled ? 'color:#ff9500;font-weight:700;' : '') + '">' + escHtml(entry.name) + (isControlled ? ' <span style="font-size:10px;font-weight:600;background:#ff9500;color:#fff;border-radius:3px;padding:1px 5px;margin-left:4px;">ACTIVE</span>' : '') + '</span>' +
      '<select onchange="updateDeviceAction(\'' + entry.deviceId + '\',this.value)">' +
        '<option value="onoff"'             + selOpt(entry.action,'onoff')             + '>Turn off</option>' +
        '<option value="dim"'               + selOpt(entry.action,'dim')               + '>Dim</option>' +
        '<option value="target_temperature"'+ selOpt(entry.action,'target_temperature')+ '>Lower thermostat</option>' +
        '<option value="charge_pause"'      + selOpt(entry.action,'charge_pause')      + '>Pause EV charging (Zaptec/Enua)</option>' +
        '<option value="dynamic_current"'   + selOpt(entry.action,'dynamic_current')   + '>Dynamic charging (Easee/Zaptec/Enua)</option>' +
        '<option value="hoiax_power"'       + selOpt(entry.action,'hoiax_power')       + '>Stepped power (Høiax)</option>' +
      '</select>' +
      '<label class="toggle" title="Managed \u2014 toggle to remove">' +
        '<input type="checkbox" checked onchange="toggleDevice(\'' + entry.deviceId + '\',this.checked)">' +
        '<span class="slider"></span>' +
      '</label>';
    return li;
  }

  function buildUnmanagedRow(dev) {
    var li = document.createElement('li');
    li.className = 'unmanaged';
    li.innerHTML =
      '<span class="handle" style="visibility:hidden">&#9776;</span>' +
      '<span class="priority-num" style="visibility:hidden">0.</span>' +
      '<span class="dev-name">' + escHtml(dev.name) + '</span>' +
      '<select id="def-action-' + dev.id.replace(/[^a-z0-9]/gi,'_') + '">' +
        '<option value="onoff">Turn off</option>' +
        '<option value="dim">Dim</option>' +
        '<option value="target_temperature">Lower thermostat</option>' +
        '<option value="charge_pause">Pause EV charging (Zaptec/Enua)</option>' +
        '<option value="dynamic_current">Dynamic charging (Easee/Zaptec/Enua)</option>' +
        '<option value="hoiax_power">Stepped power (Høiax)</option>' +
      '</select>' +
      '<label class="toggle" title="Toggle on to manage this device">' +
        '<input type="checkbox" onchange="toggleDevice(\'' + dev.id + '\',this.checked)">' +
        '<span class="slider"></span>' +
      '</label>';
    return li;
  }

  // ── Device list actions ────────────────────────────────────────────────────
  function toggleDevice(deviceId, checked) {
    if (checked) {
      if (priorityList.some(function(e) { return e.deviceId === deviceId; })) return;
      var dev = availableDevices.filter(function(d) { return d.id === deviceId; })[0];
      if (!dev) return;
      var safeId = deviceId.replace(/[^a-z0-9]/gi, '_');
      var sel = document.getElementById('def-action-' + safeId);
      var action = sel ? sel.value : 'onoff';
      var maxPriority = priorityList.reduce(function(m, e) { return Math.max(m, e.priority || 0); }, 0);
      priorityList.push({
        deviceId: deviceId, name: dev.name,
        priority: maxPriority + 1, action: action, enabled: true,
        minRuntimeSeconds: 0, minOffTimeSeconds: 60,
        circuitLimitA: 32
      });
    } else {
      var idx = -1;
      priorityList.forEach(function(e, i) { if (e.deviceId === deviceId) idx = i; });
      if (idx !== -1) {
        priorityList.splice(idx, 1);
        priorityList.forEach(function(e, i) { e.priority = i + 1; });
      }
    }
    renderAllDevices();
    savePriorityList();
  }

  function updateDeviceAction(deviceId, val) {
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) { entry.action = val; renderAllDevices(); savePriorityList(); }
  }

  function updateDeviceCircuitLimit(deviceId, val) {
    var entry = priorityList.filter(function(e) { return e.deviceId === deviceId; })[0];
    if (entry) { entry.circuitLimitA = parseInt(val) || 32; savePriorityList(); }
  }

  function reorderManaged(fromIdx, toIdx) {
    var sorted = priorityList.slice().sort(function(a, b) { return (a.priority || 0) - (b.priority || 0); });
    sorted.splice(toIdx, 0, sorted.splice(fromIdx, 1)[0]);
    sorted.forEach(function(x, i) { x.priority = i + 1; });
    renderAllDevices();
    savePriorityList();
  }

  function updateEnabledSync(checked) {
    document.getElementById('s-enabled').checked = checked;
    syncEnabledCheckbox();
  }

  function syncEnabledCheckbox() {
    var checked = document.getElementById('s-enabled').checked;
    document.getElementById('s-enabled-toggle').checked = checked;
    clearError();
    if (!_H) { showError('Not connected to Homey'); return; }
    var settings = collectSettings();
    hApi('/api/app/no.powerguard/settings', 'PUT', settings, function(err) {
      if (err) {
        showError(err.message || JSON.stringify(err));
        document.getElementById('s-enabled').checked = !checked;
        document.getElementById('s-enabled-toggle').checked = !checked;
      } else {
        showSuccess('Settings saved');
      }
    });
  }

  function pressButton(btn) {
    btn.classList.add('pressing');
    setTimeout(function() { btn.classList.remove('pressing'); }, 150);
  }

  function moveDevice(idx, direction) {
    var toIdx = idx + direction;
    if (toIdx < 0 || toIdx >= priorityList.length) return;
    reorderManaged(idx, toIdx);
  }

  // ── Touch drag handlers ────────────────────────────────────────────────────
  function onTouchDragStart(e) {
    e.preventDefault();
    _touchDragLi = e.currentTarget.parentElement;
    var items = Array.from(document.querySelectorAll('#priority-list li'));
    _touchDragIdx   = items.indexOf(_touchDragLi);
    _touchTargetIdx = _touchDragIdx;
    _touchDragLi.style.opacity = '0.45';
  }
  function onTouchDragMove(e) {
    e.preventDefault();
    if (_touchDragIdx === null) return;
    var touch = e.touches[0];
    Array.from(document.querySelectorAll('#priority-list li')).forEach(function(item, i) {
      item.classList.remove('drag-over');
      var r = item.getBoundingClientRect();
      if (touch.clientY >= r.top && touch.clientY <= r.bottom) {
        _touchTargetIdx = i;
        if (i !== _touchDragIdx) item.classList.add('drag-over');
      }
    });
  }
  function onTouchDragEnd(e) {
    e.preventDefault();
    if (_touchDragLi) _touchDragLi.style.opacity = '';
    Array.from(document.querySelectorAll('#priority-list li')).forEach(function(item) {
      item.classList.remove('drag-over');
    });
    if (_touchDragIdx !== null && _touchTargetIdx !== null && _touchDragIdx !== _touchTargetIdx) {
      reorderManaged(_touchDragIdx, _touchTargetIdx);
    }
    _touchDragIdx = null; _touchTargetIdx = null; _touchDragLi = null;
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 9 — CACHE & DEVICE DISCOVERY                         ██
  // ══════════════════════════════════════════════════════════════════
  //  a. showCacheStatus()       — display cache age and device count
  //  b. refreshDeviceCache()    — force full re-scan of Homey devices
  //  c. startCacheStatusPolling() — auto-refresh cache badge
  //
  //  ✅ STABLE
  // ══════════════════════════════════════════════════════════════════

  // ── Cache Status & Refresh ─────────────────────────────────────────────────
  function showCacheStatus() {
    var loadingEl = document.getElementById('cache-loading');
    var statusEl = document.getElementById('cache-status-text');
    var refreshEl = document.getElementById('cache-refresh-btn');
    hApi('GET', '/cache-status', null)
      .then(function(data) {
        loadingEl.style.display = 'none';
        statusEl.style.display = 'inline';
        refreshEl.style.display = 'inline';
        if (data.cacheReady && data.cacheCount > 0) {
          statusEl.textContent = data.cacheCount + ' devices (updated ' + data.cacheAgeSeconds + 's ago)';
          statusEl.style.color = '#34c759';
          if (availableDevices.length === 0) {
            dbg('Cache ready, reloading device list...');
            loadAll();
          }
        } else if (data.cacheReady) {
          statusEl.textContent = 'Cache ready (0 devices)';
          statusEl.style.color = '#ff9500';
        } else {
          statusEl.textContent = 'Cache loading...';
          statusEl.style.color = 'var(--text-muted)';
        }
      })
      .catch(function() {
        if (availableDevices.length > 0) {
          loadingEl.style.display = 'none';
          statusEl.style.display = 'inline';
          refreshEl.style.display = 'inline';
          statusEl.textContent = availableDevices.length + ' devices loaded';
          statusEl.style.color = '#34c759';
        }
      });
  }

  function refreshDeviceCache() {
    var statusEl = document.getElementById('cache-status-text');
    statusEl.textContent = 'Refreshing...';
    statusEl.style.color = 'var(--text-muted)';
    hApi('POST', '/device-cache-refresh', null)
      .then(function(data) {
        if (data.success) {
          showCacheStatus();
          setTimeout(loadAll, 500);
        } else {
          statusEl.textContent = 'Refresh failed';
          statusEl.style.color = '#ff3b30';
        }
      })
      .catch(function(err) {
        statusEl.textContent = (err.message || 'Error');
        statusEl.style.color = '#ff3b30';
      });
  }

  function startCacheStatusPolling() {
    showCacheStatus();
    setInterval(showCacheStatus, 5000);
  }

  // ── Range labels ───────────────────────────────────────────────────────────
  document.getElementById('s-smoothingWindow').addEventListener('input', function() {
    document.getElementById('v-smoothingWindow').textContent = this.value;
  });
  document.getElementById('s-spikeMultiplier').addEventListener('input', function() {
    document.getElementById('v-spikeMultiplier').textContent = parseFloat(this.value).toFixed(1) + '\u00d7';
  });
  document.getElementById('s-hysteresisCount').addEventListener('input', function() {
    document.getElementById('v-hysteresisCount').textContent = this.value;
  });

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 10 — ENTRY POINT                                      ██
  // ══════════════════════════════════════════════════════════════════
  //  a. Range label updaters  — sync <input type=range> display values
  //  b. onHomeyReady()        — Homey SDK calls this on page load;
  //                             bootstraps auth, loads all data,
  //                             starts polling
  //
  //  ✅ STABLE — only edit if Homey SDK init flow changes
  // ══════════════════════════════════════════════════════════════════

  // ── Entry point ────────────────────────────────────────────────────────────
  function onHomeyReady(Homey) {
    _H = Homey;
    dbg('onHomeyReady called');

    Homey.ready();
    dbg('Homey.ready() called, api=' + (typeof Homey.api));

    // Setup event listeners
    var voltageSelect = document.getElementById('s-voltageSystem');
    if (voltageSelect) {
      voltageSelect.addEventListener('change', function() {
        _updateVoltageDetectedBadge();
        updatePhaseConfigVisibility();
        saveAll();
      });
    }

    var mainCircuitInput = document.getElementById('s-mainCircuitA');
    if (mainCircuitInput) {
      mainCircuitInput.addEventListener('change', function() {
        renderChargerDetails();
        saveAll();
      });
    }

    // Load all data via Homey.api('GET', '/all', ...)
    hApi('GET', '/all', null)
      .then(function(data) {
        dbg('API connected! Keys: ' + Object.keys(data).join(', '));
        showMain();

        var settings = data.settings || {};
        var defs = {
          enabled: true, profile: 'normal', powerLimitW: 10000,
          phase1LimitA: 0, phase2LimitA: 0, phase3LimitA: 0,
          smoothingWindow: 5, spikeMultiplier: 2.0,
          hysteresisCount: 3, cooldownSeconds: 30, priorityList: []
        };
        Object.keys(defs).forEach(function(k) {
          if (settings[k] == null) settings[k] = defs[k];
        });

        _detectedVoltageSystem = data.detectedVoltageSystem || '230v-1phase';
        applySettings(settings);
        updateStatusUI(data.status || {});
        availableDevices = Array.isArray(data.devices) ? data.devices : [];
        renderAllDevices();
        renderChargerDetails();  // Initial render of charger power details
        syncChargerLimitsFromDevices(true);  // Auto-sync live values from charger devices (silent)
        dbg('Initial load: ' + availableDevices.length + ' devices');

        // Immediately update cache status bar since devices are loaded
        if (availableDevices.length > 0) {
          var _l = document.getElementById('cache-loading');
          var _s = document.getElementById('cache-status-text');
          var _r = document.getElementById('cache-refresh-btn');
          if (_l) _l.style.display = 'none';
          if (_s) { _s.style.display = 'inline'; _s.textContent = availableDevices.length + ' devices loaded'; _s.style.color = '#34c759'; }
          if (_r) _r.style.display = 'inline';
        }

        startCacheStatusPolling();

        // Poll live status every 2 seconds for responsive updates
        setInterval(function() {
          hApi('GET', '/status', null)
            .then(function(s) { if (s) updateStatusUI(s); })
            .catch(function(err) { dbg('Status poll error: ' + (err.message || err)); });
        }, 2000);

        // Full data refresh every 30 seconds to keep everything in sync
        setInterval(function() {
          loadAll();
        }, 30000);
      })
      .catch(function(err) {
        dbg('Initial load error: ' + (err.message || err));
        showError('Cannot connect: ' + (err.message || err));
        showMain();
      });

    // Realtime events (per SDK docs: Homey.on(event, callback))
    try {
      Homey.on('status', function(s) { if (s) updateStatusUI(s); });
      dbg('Registered realtime: status');
    } catch (e) { dbg('Realtime status failed: ' + e.message); }

    try {
      Homey.on('priorityList', function(list) {
        if (!Array.isArray(list)) return;
        priorityList = list;
        renderAllDevices();
        renderChargerDetails();  // Update charger details when priority list changes
      });
      dbg('Registered realtime: priorityList');
    } catch (e) { dbg('Realtime priorityList failed: ' + e.message); }

    // Refresh data every time the page becomes visible (e.g. switching back to the app)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) loadAll();
    });

    // Periodic sync fallback every 15s
    setInterval(function() {
      hApi('GET', '/settings-all', null)
        .then(function(s) {
          if (!s || !s.priorityList) return;
          var incoming = JSON.stringify(s.priorityList.slice().sort(function(a, b) { return a.deviceId < b.deviceId ? -1 : 1; }));
          var current = JSON.stringify(priorityList.slice().sort(function(a, b) { return a.deviceId < b.deviceId ? -1 : 1; }));
          if (incoming !== current) {
            priorityList = s.priorityList;
            renderAllDevices();
            renderChargerDetails();  // Update charger details if priority list changed
          }
        })
        .catch(function() {});
    }, 15000);
  }

  // ══════════════════════════════════════════════════════════════════
  // ██ SECTION 11 — LOG TAB                                          ██
  // ══════════════════════════════════════════════════════════════════
  //  a. loadAppLog()          — fetch log entries from app
  //  b. filterAppLog()        — filter by category (mitigation, charger…)
  //  c. renderAppLogEntries() — HTML render of log list
  //  d. renderHanSummary()    — HAN meter section of log
  //  e. renderMitigationScan() — last mitigation scan results
  //  f. renderSystemInfo()    — system / version section
  //  g. copyAppLog()          — copy log to clipboard
  //  h. fallbackCopy()        — clipboard fallback for older browsers
  //  i. toggleLogAutoRefresh() — enable/disable auto-refresh
  //
  //  🔵 ACTIVE — Log tab
  // ══════════════════════════════════════════════════════════════════

  // ─── Log Tab ──────────────────────────────────────────────────────────────
  var _appLogData = null;       // Full response from /app-log
  var _appLogFilter = 'all';    // Current filter: 'all' | 'han' | 'charger' | etc.
  var _appLogAutoRefreshTimer = null;

  var LOG_CATEGORY_COLORS = {
    han: '#34c759',
    charger: '#007aff',
    mitigation: '#ff9500',
    energy: '#af52de',
    cache: '#5ac8fa',
    system: '#8e8e93'
  };

  function loadFirmwareInfo() {
    var search = (document.getElementById('firmware-search').value || '').trim();
    var el = document.getElementById('firmware-results');
    if (!search) { el.innerHTML = '<span style="color:#ff3b30;">Enter a search term first.</span>'; return; }
    el.innerHTML = '<span style="color:var(--text-muted);">Loading…</span>';
    hApi('GET', '/firmwareInfo?search=' + encodeURIComponent(search), null)
      .then(function(data) {
        if (!data || data.length === 0) {
          el.innerHTML = '<span style="color:var(--text-muted);">No devices found matching "' + escHtml(search) + '".</span>';
          return;
        }
        el.innerHTML = data.map(function(d) {
          var settings = Object.entries(d.allSettings || {}).map(function(kv) {
            return '<span style="color:var(--text-muted);">' + escHtml(kv[0]) + ':</span> ' + escHtml(String(kv[1]));
          }).join('<br>');
          return '<div style="padding:8px 0; border-bottom:1px solid var(--border-light);">' +
            '<div style="font-weight:600; color:var(--text-primary);">' + escHtml(d.name) + '</div>' +
            '<div style="color:var(--text-muted); font-size:11px; margin-top:2px;">Driver: ' + escHtml(d.driver) + ' &nbsp;|&nbsp; Class: ' + escHtml(d.class || '–') + '</div>' +
            '<div style="margin-top:4px;"><b>Firmware:</b> ' + escHtml(String(d.firmware ?? '–')) + ' &nbsp; <b>HW:</b> ' + escHtml(String(d.hardwareVersion ?? '–')) + '</div>' +
            (settings ? '<details style="margin-top:4px;"><summary style="cursor:pointer;font-size:11px;color:var(--text-muted);">All settings</summary><div style="font-size:11px;line-height:1.8;padding-top:4px;">' + settings + '</div></details>' : '') +
            '</div>';
        }).join('');
      })
      .catch(function(err) {
        el.innerHTML = '<span style="color:#ff3b30;">Error: ' + escHtml(err.message) + '</span>';
      });
  }

  function loadAppLog() {
    hApi('GET', '/app-log', null)
      .then(function(data) {
        _appLogData = data;
        renderAppLogEntries();
        renderHanSummary(data.hanDiagnostic || {});
        renderMitigationScan(data.lastMitigationScan || []);
        renderSystemInfo(data);
      })
      .catch(function(err) {
        var el = document.getElementById('app-log-entries');
        if (el) el.innerHTML = '<span style="color:#ff3b30">Error loading log: ' + (err.message || err) + '</span>';
      });
  }

  function filterAppLog(category) {
    _appLogFilter = category;
    // Update button active states
    var btns = document.querySelectorAll('.log-filter-btn');
    for (var i = 0; i < btns.length; i++) {
      btns[i].classList[btns[i].getAttribute('data-filter') === category ? 'add' : 'remove']('active');
    }
    renderAppLogEntries();
  }

  function renderAppLogEntries() {
    if (!_appLogData) return;
    var el = document.getElementById('app-log-entries');
    if (!el) return;

    // Merge appLog and mitigationLog into one list
    var entries = [];

    // AppLog entries (already categorized)
    var appLog = _appLogData.appLog || [];
    appLog.forEach(function(e) {
      entries.push({ time: e.time, category: e.category || 'system', message: e.message });
    });

    // MitigationLog entries (category = mitigation)
    var mitLog = _appLogData.mitigationLog || [];
    mitLog.forEach(function(e) {
      entries.push({ time: e.time, category: 'mitigation', message: e.message });
    });

    // Sort newest first
    entries.sort(function(a, b) {
      return (b.time || '').localeCompare(a.time || '');
    });

    // Apply filter
    if (_appLogFilter !== 'all') {
      entries = entries.filter(function(e) { return e.category === _appLogFilter; });
    }

    if (entries.length === 0) {
      el.innerHTML = '<span style="color:var(--text-muted)">No log entries' +
        (_appLogFilter !== 'all' ? ' for category "' + _appLogFilter + '"' : '') + '</span>';
      return;
    }

    var html = '';
    entries.forEach(function(e) {
      var color = LOG_CATEGORY_COLORS[e.category] || '#8e8e93';
      var timeStr = e.time ? e.time.replace('T', ' ').substring(0, 19) : '??';
      html += '<div style="margin-bottom:3px; line-height:1.4;">' +
        '<span style="color:var(--text-muted)">' + timeStr + '</span> ' +
        '<span style="display:inline-block; background:' + color + '; color:#fff; font-size:9px; padding:1px 5px; border-radius:3px; min-width:55px; text-align:center;">' +
        (e.category || 'system').toUpperCase() + '</span> ' +
        '<span>' + (e.message || '') + '</span>' +
        '</div>';
    });

    el.innerHTML = html;
  }

  function renderHanSummary(han) {
    var el = document.getElementById('log-han-summary');
    if (!el) return;

    if (!han || !han.hanConnected) {
      el.innerHTML = '<span style="color:var(--text-muted)">No HAN meter connected</span>';
      return;
    }

    var lastAge = han.lastReadingAgeSeconds != null ? han.lastReadingAgeSeconds + 's ago' : 'unknown';
    var ageColor = (han.lastReadingAgeSeconds != null && han.lastReadingAgeSeconds < 15) ? '#34c759' : '#ff9500';

    var html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px 16px;">' +
      '<div>Status: <strong style="color:#34c759">Connected</strong></div>' +
      '<div>Last reading: <strong style="color:' + ageColor + '">' + lastAge + '</strong></div>' +
      '<div>Device: <strong>' + (han.hanDeviceName || 'N/A') + '</strong></div>' +
      '<div>Brand: <strong>' + (han.hanBrand || 'N/A') + '</strong></div>' +
      '<div>Source: <strong>' + (han.readingSource || 'none') + '</strong></div>' +
      '<div>Mode: <strong>' + (han.selectionMode || 'auto') + '</strong></div>' +
      '<div>Events: <strong>' + (han.eventCount || 0) + '</strong></div>' +
      '<div>Polls: <strong>' + (han.pollCount || 0) + '</strong></div>' +
      '<div>Spikes filtered: <strong>' + (han.spikeFilterCount || 0) + '</strong></div>' +
      '<div>Reconnects: <strong>' + (han.watchdogReconnects || 0) + '</strong></div>' +
      '</div>';

    // Capabilities
    if (han.capabilities && han.capabilities.length > 0) {
      html += '<div style="margin-top:8px; color:var(--text-muted);">Capabilities: ' +
        han.capabilities.join(', ') + '</div>';
    }

    // Recent raw readings
    if (han.rawLog && han.rawLog.length > 0) {
      html += '<div style="margin-top:8px;"><strong>Recent readings:</strong></div>';
      html += '<div style="font-family:monospace; font-size:10px; background:var(--bg-surface); padding:6px; border-radius:6px; max-height:120px; overflow-y:auto;">';
      han.rawLog.slice().reverse().forEach(function(r) {
        var srcColor = r.source === 'event' ? '#34c759' : r.source === 'poll' ? '#ff9500' : r.source === 'spike-filtered' ? '#ff3b30' : '#8e8e93';
        var t = r.time ? r.time.replace('T', ' ').substring(0, 19) : '??';
        html += '<div><span style="color:var(--text-muted)">' + t + '</span> ' +
          '<span style="color:' + srcColor + '">[' + (r.source || '?') + ']</span> ' +
          '<strong>' + r.value + 'W</strong></div>';
      });
      html += '</div>';
    }

    // Power buffer
    if (han.powerBuffer && han.powerBuffer.length > 0) {
      html += '<div style="margin-top:6px; color:var(--text-muted); font-size:10px;">Power buffer (last ' +
        han.powerBuffer.length + '): ' + han.powerBuffer.map(function(v) { return Math.round(v); }).join(', ') + '</div>';
    }

    el.innerHTML = html;
  }

  function renderMitigationScan(scan) {
    var el = document.getElementById('log-mitigation-scan');
    if (!el) return;

    if (!scan || scan.length === 0) {
      el.innerHTML = '<span style="color:var(--text-muted)">No mitigation scan data yet (scans run when power exceeds the limit)</span>';
      return;
    }

    var html = '<table style="width:100%; font-size:11px; border-collapse:collapse;">' +
      '<tr style="border-bottom:1px solid var(--border-color);"><th style="text-align:left; padding:4px;">Device</th><th style="text-align:left; padding:4px;">Action</th><th style="text-align:left; padding:4px;">Result</th></tr>';
    scan.forEach(function(s) {
      var color = s.result === 'SUCCESS' ? '#34c759' :
                  s.result && s.result.indexOf('error') >= 0 ? '#ff3b30' :
                  s.result && s.result.indexOf('disabled') >= 0 ? '#8e8e93' : 'var(--text-primary)';
      html += '<tr style="border-bottom:1px solid var(--border-color);">' +
        '<td style="padding:4px;">' + (s.name || '?') + '</td>' +
        '<td style="padding:4px;">' + (s.action || '?') + '</td>' +
        '<td style="padding:4px; color:' + color + '">' + (s.result || '?') + '</td></tr>';
    });
    html += '</table>';
    el.innerHTML = html;
  }

  function renderSystemInfo(data) {
    var el = document.getElementById('log-system-info');
    if (!el) return;

    var uptime = data.uptimeSeconds || 0;
    var uptimeStr = Math.floor(uptime / 3600) + 'h ' + Math.floor((uptime % 3600) / 60) + 'm ' + (uptime % 60) + 's';

    var html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px 16px;">' +
      '<div>Uptime: <strong>' + uptimeStr + '</strong></div>' +
      '<div>Current power: <strong>' + (data.currentPowerW || 0) + 'W</strong></div>' +
      '<div>Power limit: <strong>' + (data.limitW || 0) + 'W</strong></div>' +
      '<div>Over limit count: <strong>' + (data.overLimitCount || 0) + '</strong></div>' +
      '<div>Device cache: <strong>' + (data.deviceCacheCount || 0) + ' devices</strong></div>' +
      '<div>Mitigated: <strong>' + ((data.mitigatedDevices || []).length) + ' device(s)</strong></div>' +
      '</div>';

    // Settings summary
    if (data.settings) {
      var s = data.settings;
      html += '<div style="margin-top:10px;"><strong>Settings:</strong></div>' +
        '<div style="font-family:monospace; font-size:10px; background:var(--bg-surface); padding:6px; border-radius:6px;">' +
        'enabled: ' + s.enabled + ' | profile: ' + s.profile + ' | limit: ' + s.powerLimitW + 'W<br>' +
        'smoothing: ' + s.smoothingWindow + ' | hysteresis: ' + s.hysteresisCount + ' | cooldown: ' + s.cooldownSeconds + 's<br>' +
        'voltage: ' + s.voltageSystem + ' | mainCircuit: ' + s.mainCircuitA + 'A | meter: ' + s.selectedMeterDeviceId +
        '</div>';
    }

    // Mitigated devices
    if (data.mitigatedDevices && data.mitigatedDevices.length > 0) {
      html += '<div style="margin-top:10px;"><strong>Currently mitigated:</strong></div>';
      data.mitigatedDevices.forEach(function(m) {
        html += '<div style="font-size:11px; padding:2px 0;">- ' + m.deviceId + ' (' + m.action + ')</div>';
      });
    }

    el.innerHTML = html;
  }

  function copyAppLog(section) {
    var text = '';

    if (section === 'all') {
      // Full JSON dump of everything
      text = JSON.stringify(_appLogData || {}, null, 2);
    } else if (section === 'filtered') {
      // Currently filtered log entries
      if (!_appLogData) { text = '(no data)'; }
      else {
        var entries = (_appLogData.appLog || []).concat(
          (_appLogData.mitigationLog || []).map(function(e) {
            return { time: e.time, category: 'mitigation', message: e.message };
          })
        );
        if (_appLogFilter !== 'all') {
          entries = entries.filter(function(e) { return e.category === _appLogFilter; });
        }
        entries.sort(function(a, b) { return (b.time || '').localeCompare(a.time || ''); });
        text = entries.map(function(e) {
          return (e.time || '') + ' [' + (e.category || '') + '] ' + (e.message || '');
        }).join('\n');
      }
    } else if (section === 'han-diagnostic') {
      text = JSON.stringify((_appLogData || {}).hanDiagnostic || {}, null, 2);
    } else if (section === 'mitigation-scan') {
      text = JSON.stringify((_appLogData || {}).lastMitigationScan || [], null, 2);
    } else if (section === 'system-info') {
      var d = _appLogData || {};
      text = JSON.stringify({
        uptimeSeconds: d.uptimeSeconds,
        currentPowerW: d.currentPowerW,
        limitW: d.limitW,
        overLimitCount: d.overLimitCount,
        deviceCacheCount: d.deviceCacheCount,
        mitigatedDevices: d.mitigatedDevices,
        settings: d.settings
      }, null, 2);
    }

    // Copy to clipboard
    var msgEl = document.getElementById('log-copy-msg');
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        if (msgEl) {
          msgEl.style.display = 'block';
          msgEl.style.color = '#34c759';
          msgEl.textContent = 'Copied to clipboard (' + text.length + ' chars)';
          setTimeout(function() { msgEl.style.display = 'none'; }, 3000);
        }
      }).catch(function() {
        fallbackCopy(text, msgEl);
      });
    } else {
      fallbackCopy(text, msgEl);
    }
  }

  function fallbackCopy(text, msgEl) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      if (msgEl) {
        msgEl.style.display = 'block';
        msgEl.style.color = '#34c759';
        msgEl.textContent = 'Copied to clipboard (' + text.length + ' chars)';
        setTimeout(function() { msgEl.style.display = 'none'; }, 3000);
      }
    } catch (e) {
      if (msgEl) {
        msgEl.style.display = 'block';
        msgEl.style.color = '#ff3b30';
        msgEl.textContent = 'Copy failed — please select and copy manually';
        setTimeout(function() { msgEl.style.display = 'none'; }, 5000);
      }
    }
    document.body.removeChild(ta);
  }

  function toggleLogAutoRefresh(enabled) {
    if (_appLogAutoRefreshTimer) {
      clearInterval(_appLogAutoRefreshTimer);
      _appLogAutoRefreshTimer = null;
    }
    if (enabled) {
      _appLogAutoRefreshTimer = setInterval(function() {
        // Only refresh if log tab is visible
        var logTab = document.getElementById('tab-log');
        if (logTab && logTab.style.display !== 'none') {
          loadAppLog();
        }
      }, 5000);
    }
  }
</script>
</body>
</html>
